<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Peak to Plains Well Testing</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-header {
      background: var(--navy);
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }
    .admin-header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-header h1 {
      color: white;
      margin: 0;
      font-size: 1.8rem;
    }
    .admin-header .logout-btn {
      background: var(--brown);
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }
    .admin-menu-dropdown {
      position: relative;
      display: inline-block;
    }
    .admin-menu-btn {
      background: var(--navy);
      color: white;
      border: none;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }
    .admin-menu-btn:hover {
      background: var(--green);
    }
    .admin-menu-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background: white;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
      overflow: hidden;
    }
    .admin-menu-dropdown-content.show {
      display: block;
    }
    .admin-menu-dropdown-content a,
    .admin-menu-dropdown-content button {
      display: block;
      width: 100%;
      padding: 0.8rem 1.5rem;
      text-align: left;
      background: white;
      border: none;
      color: var(--navy);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .admin-menu-dropdown-content a:hover,
    .admin-menu-dropdown-content button:hover {
      background: #f5f5f5;
    }
    .admin-menu-dropdown-content a:first-child,
    .admin-menu-dropdown-content button:first-child {
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    .admin-menu-dropdown-content a:last-child,
    .admin-menu-dropdown-content button:last-child {
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    .jobs-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }
    .jobs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .jobs-list {
      display: grid;
      gap: 1.5rem;
    }
    .job-card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-left: 4px solid var(--green);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .job-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .job-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }
    .job-address {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--navy);
      text-decoration: none;
    }
    .job-address:hover {
      color: var(--green);
    }
    .edit-address-btn {
      background: none;
      border: none;
      color: var(--navy);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
      opacity: 0.6;
      transition: opacity 0.2s;
      display: inline-flex;
      align-items: center;
      margin-left: 0.5rem;
    }
    .edit-address-btn:hover {
      opacity: 1;
      color: var(--green);
    }
    .address-edit-form {
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding: 1rem;
      background: #f9f9f9;
      border-radius: 8px;
      border: 2px solid var(--green);
    }
    .address-edit-form.active {
      display: flex;
    }
    .address-edit-form input {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    .address-edit-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .address-edit-actions button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-save-address {
      background: var(--green);
      color: white;
    }
    .btn-save-address:hover {
      background: #1f4d3a;
    }
    .btn-cancel-address {
      background: #ddd;
      color: #666;
    }
    .btn-cancel-address:hover {
      background: #bbb;
    }
    .job-id {
      font-size: 0.9rem;
      color: var(--gray);
      font-family: monospace;
    }
    .job-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    .job-info-item {
      font-size: 0.95rem;
    }
    .job-info-label {
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .job-info-value {
      color: var(--navy);
      font-weight: 600;
    }
    .status-badge {
      display: inline-block;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .status-awaiting-payment {
      background: #ffeaa7;
      color: #6c5ce7;
    }
    .status-complete {
      background: #d4edda;
      color: #155724;
    }
    .status-completed {
      background: #d4edda;
      color: #155724;
    }
    .filter-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 0.6rem 1.2rem;
      border: 2px solid var(--navy);
      background: white;
      color: var(--navy);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover {
      background: var(--navy);
      color: white;
    }
    .filter-btn.active {
      background: var(--navy);
      color: white;
    }
    .job-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    .btn-create-report {
      background: var(--green);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      cursor: pointer;
    }
    .btn-create-report:hover {
      background: #1f4d3a;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray);
    }
    .empty-state h2 {
      color: var(--navy);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- INSERT HEADER -->
  <div w3-include-html="header.html"></div>
  
  <!-- Check authentication -->
  <script>
    if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
      window.location.href = 'admin-login.html';
    }
  </script>
  
  <!-- Add logout button and dropdown menu to header after it loads -->
  <script>
    function addLogoutAndMenuToHeader() {
      const header = document.querySelector('.site-header nav');
      if (header) {
        // Check if logout button already exists
        if (!document.getElementById('headerLogoutBtn')) {
          const logoutBtn = document.createElement('a');
          logoutBtn.id = 'headerLogoutBtn';
          logoutBtn.href = 'javascript:void(0)';
          logoutBtn.onclick = function() { logout(); return false; };
          logoutBtn.style.cssText = 'background:var(--brown); color:white; padding:0.7rem 1.4rem; border-radius:8px; font-weight:700; font-size:1rem; text-decoration:none; cursor:pointer';
          logoutBtn.textContent = 'Logout';
          header.appendChild(logoutBtn);
        }
        
        // Check if dropdown menu already exists
        if (!document.getElementById('headerAdminMenuDropdown')) {
          const menuContainer = document.createElement('div');
          menuContainer.className = 'admin-menu-dropdown';
          menuContainer.style.cssText = 'position:relative; display:inline-block';
          menuContainer.innerHTML = `
            <button class="admin-menu-btn" onclick="toggleAdminMenu()" title="Admin Menu" style="background:var(--navy); color:white; border:none; padding:0.7rem 1rem; border-radius:8px; cursor:pointer; font-size:1.2rem; display:flex; align-items:center; justify-content:center; width:40px; height:40px">
              ‚ò∞
            </button>
            <div class="admin-menu-dropdown-content" id="adminMenuDropdown">
              <button onclick="exportData()">Export Data</button>
              <button onclick="document.getElementById('importFile').click()">Import Data</button>
              <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
          `;
          header.appendChild(menuContainer);
        }
      } else {
        // Retry if header not loaded yet
        setTimeout(addLogoutAndMenuToHeader, 100);
      }
    }
    // Wait for header to load
    setTimeout(addLogoutAndMenuToHeader, 200);
  </script>

  <div class="admin-header">
    <div class="container">
      <h1>Admin Dashboard</h1>
    </div>
  </div>

  <div class="jobs-container">
    <div class="jobs-header">
      <h2 style="color:var(--navy);margin:0">Scheduled Jobs</h2>
      <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
        <div id="jobCount" style="color:var(--gray)">0 jobs</div>
        <a href="admin-calendar.html" style="background:var(--navy);color:white;padding:0.8rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:600;white-space:nowrap">Calendar</a>
        <a href="admin-jobs-map.html" style="background:var(--navy);color:white;padding:0.8rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:600;white-space:nowrap">Jobs Map</a>
        <a href="admin-techs.html" style="background:var(--brown);color:white;padding:0.8rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:600;white-space:nowrap">Techs</a>
        <a href="admin-add-job.html" class="btn" style="background:var(--green);color:white;padding:0.8rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:600">+ Add Job</a>
      </div>
    </div>

    <div class="filter-section" style="margin-bottom: 2rem;">
      <div style="margin-bottom: 1rem;">
        <h3 style="margin-bottom: 0.5rem; color: var(--navy); font-size: 1rem; font-weight: 600;">Filter by Status:</h3>
        <div class="filter-buttons">
          <button class="filter-btn active" onclick="filterJobs('all')">All</button>
          <button class="filter-btn" onclick="filterJobs('pending')">Pending</button>
          <button class="filter-btn" onclick="filterJobs('awaiting-payment')">Awaiting Payment</button>
          <button class="filter-btn" onclick="filterJobs('complete')">Complete</button>
          <button class="filter-btn" onclick="filterJobs('archived')">Archived</button>
        </div>
      </div>
      <div>
        <h3 style="margin-bottom: 0.5rem; color: var(--navy); font-size: 1rem; font-weight: 600;">Filter by Tech:</h3>
        <div class="filter-buttons" id="techFilters">
          <button class="filter-btn tech-filter-btn active" onclick="filterByTech('all')">All</button>
          <!-- Tech filter buttons will be added here dynamically -->
        </div>
      </div>
    </div>

    <div id="jobsList" class="jobs-list">
      <!-- Jobs will be loaded here -->
    </div>

    <div id="emptyState" class="empty-state" style="display:none">
      <h2>No Jobs Scheduled</h2>
      <p>Jobs will appear here once customers schedule appointments.</p>
    </div>
  </div>

  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script src="api.js"></script>
  <script>w3.includeHTML();</script>
  <script>
    let currentFilter = 'all';
    let currentTechFilter = 'all';
    let allJobs = [];
    let allTechs = [];

    // Format phone number for display
    function formatTechPhone(phone) {
      if (!phone) return '';
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 10) {
        return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
      } else if (cleaned.length === 11 && cleaned[0] === '1') {
        return `(${cleaned.slice(1, 4)}) ${cleaned.slice(4, 7)}-${cleaned.slice(7)}`;
      }
      return phone;
    }

    // Load techs
    async function loadTechs() {
      try {
        allTechs = await window.techsAPI.getAll();
        renderTechFilters();
      } catch (error) {
        console.error('Error loading techs:', error);
        allTechs = [];
      }
    }
    
    // Render tech filter buttons
    function renderTechFilters() {
      const techFiltersContainer = document.getElementById('techFilters');
      if (!techFiltersContainer) return;
      
      // Clear existing buttons (except "All" which is in HTML)
      const existingButtons = techFiltersContainer.querySelectorAll('.tech-filter-btn');
      existingButtons.forEach(btn => {
        if (btn.textContent.trim() !== 'All') {
          btn.remove();
        }
      });
      
      // Update "All" button active state
      const allBtn = techFiltersContainer.querySelector('button');
      if (allBtn && allBtn.textContent.trim() === 'All') {
        allBtn.classList.remove('active');
        if (currentTechFilter === 'all') {
          allBtn.classList.add('active');
        }
        // Ensure onclick is set
        allBtn.onclick = () => filterByTech('all');
      }
      
      // Add a button for each active tech
      allTechs.filter(tech => tech.active !== false).forEach(tech => {
        const techBtn = document.createElement('button');
        techBtn.className = 'filter-btn tech-filter-btn';
        techBtn.textContent = tech.name;
        techBtn.onclick = () => filterByTech(tech.id);
        if (currentTechFilter === tech.id) {
          techBtn.classList.add('active');
        }
        techFiltersContainer.appendChild(techBtn);
      });
    }

    function logout() {
      sessionStorage.clear(); // Clear all session storage
      window.location.href = 'admin-login.html?logout=true';
    }
    
    // Make logout globally accessible
    window.logout = logout;

    function filterJobs(filter) {
      currentFilter = filter;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      if (event && event.target) {
        event.target.classList.add('active');
      }
      
      // Reload jobs with filter
      loadJobs();
    }
    
    function filterByTech(techId) {
      currentTechFilter = techId;
      
      // Update active tech filter button
      document.querySelectorAll('.tech-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        // Check if this is the selected button
        if (techId === 'all' && btn.textContent.trim() === 'All') {
          btn.classList.add('active');
        } else if (techId !== 'all') {
          const tech = allTechs.find(t => t.id === techId);
          if (tech && btn.textContent.trim() === tech.name) {
            btn.classList.add('active');
          }
        }
      });
      
      // Reload jobs with filter
      loadJobs();
    }

    // Load jobs from API
    async function loadJobs() {
      try {
        allJobs = await window.jobsAPI.getAll();
        
        // Also load reports to check which jobs have reports
        let reports = [];
        try {
          reports = await window.reportsAPI.getAll();
        } catch (error) {
          console.warn('Could not load reports:', error);
        }
        
        // Create a map of jobId to report for quick lookup
        const reportMap = {};
        reports.forEach(report => {
          if (report.jobId) {
            reportMap[report.jobId] = report;
          }
        });
      
        // Filter jobs based on current filter and tech filter
        let filteredJobs = allJobs;
        
        // First apply status filter
        if (currentFilter === 'archived') {
          // Show only archived jobs
          filteredJobs = allJobs.filter(job => job.archived === true);
        } else if (currentFilter !== 'all') {
          // Filter by status, but exclude archived jobs
          filteredJobs = allJobs.filter(job => {
            if (job.archived === true) return false; // Exclude archived from other filters
            const status = (job.status || 'pending').toLowerCase();
            if (currentFilter === 'complete') {
              return status === 'complete' || status === 'completed';
            }
            return status === currentFilter;
          });
        } else {
          // "All" filter - exclude archived jobs
          filteredJobs = allJobs.filter(job => job.archived !== true);
        }
        
        // Then apply tech filter
        if (currentTechFilter !== 'all') {
          filteredJobs = filteredJobs.filter(job => {
            // Check if job's assignedTechId matches the selected tech
            return job.assignedTechId === currentTechFilter;
          });
        }

        const jobsList = document.getElementById('jobsList');
        const emptyState = document.getElementById('emptyState');
        const jobCount = document.getElementById('jobCount');

        jobCount.textContent = `${filteredJobs.length} job${filteredJobs.length !== 1 ? 's' : ''} (${allJobs.length} total)`;

        if (filteredJobs.length === 0) {
          jobsList.style.display = 'none';
          emptyState.style.display = 'block';
          const filterText = currentFilter === 'all' ? '' : currentFilter.replace('-', ' ');
          const techText = currentTechFilter !== 'all' ? ` for ${allTechs.find(t => t.id === currentTechFilter)?.name || 'selected tech'}` : '';
          emptyState.innerHTML = `
            <h2>No ${filterText} Jobs${techText}</h2>
            <p>${currentFilter === 'all' && currentTechFilter === 'all' ? 'Jobs will appear here once customers schedule appointments.' : 'No jobs match this filter.'}</p>
          `;
          return;
        }

        jobsList.style.display = 'grid';
        emptyState.style.display = 'none';
        jobsList.innerHTML = filteredJobs.map((job, index) => {
          const jobId = job.id || `job-${Date.now()}-${index}`;
          let status = (job.status || 'pending').toLowerCase();
          
          // Normalize status
          if (status === 'completed') {
            status = 'complete';
          }
          
          const statusClass = `status-${status}`;
          let statusText = status.replace('-', ' ');
          statusText = statusText.split(' ').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
          ).join(' ');

          // Check if report exists
          const hasReport = reportMap[jobId] !== undefined;
          const report = reportMap[jobId];

          // Get assigned tech info
          let assignedTechDisplay = 'Not assigned';
          if (job.assignedTechId) {
            const tech = allTechs.find(t => t.id === job.assignedTechId);
            if (tech) {
              assignedTechDisplay = `<a href="admin-tech-detail.html?techId=${tech.id}" style="color:var(--green);text-decoration:none;font-weight:600">${tech.name}</a>`;
            } else {
              assignedTechDisplay = 'Unknown';
            }
          }

          return `
            <div class="job-card">
              <div class="job-card-header">
                <div style="display:flex;flex-direction:column;gap:0.5rem;flex:1">
                  <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap">
                    <a href="admin-job-detail.html?jobId=${jobId}" class="job-address">
                      ${job.address || job.propertyAddress || 'No address provided'}${job.city ? ', ' + job.city : ''}${job.zip ? ' ' + job.zip : ''}
                    </a>
                    <button class="edit-address-btn" onclick="editAddress('${jobId}')" title="Edit address">
                      ‚úèÔ∏è
                    </button>
                    ${(job.address || job.propertyAddress)
                      ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(((job.address || job.propertyAddress) + (job.city ? ', ' + job.city : '') + (job.zip ? ' ' + job.zip : '')).trim())}" target="_blank" rel="noopener noreferrer" style="background:var(--green);color:white;padding:0.4rem 0.8rem;border-radius:6px;text-decoration:none;font-size:0.85rem;font-weight:600;white-space:nowrap">Map</a>`
                      : ''
                    }
                  </div>
                  <div class="address-edit-form" id="addressEditForm_${jobId}">
                    <input type="text" id="editPropertyAddress_${jobId}" placeholder="Property Address" value="${job.address || job.propertyAddress || ''}">
                    <input type="text" id="editCity_${jobId}" placeholder="City" value="${job.city || ''}">
                    <input type="text" id="editZip_${jobId}" placeholder="ZIP Code" value="${job.zip || ''}" maxlength="5">
                    <div class="address-edit-actions">
                      <button class="btn-save-address" onclick="saveAddress('${jobId}')">Save</button>
                      <button class="btn-cancel-address" onclick="cancelEditAddress('${jobId}')">Cancel</button>
                    </div>
                  </div>
                </div>
                <span class="job-id">ID: ${jobId}</span>
              </div>
              <div class="job-info">
                <div class="job-info-item">
                  <div class="job-info-label">Client Name</div>
                  <div class="job-info-value">${job.client_name || job.name || 'N/A'}</div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">County</div>
                  <div class="job-info-value">${job.county || 'N/A'}</div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">Role</div>
                  <div class="job-info-value">${job.role || job.userRole || 'N/A'}</div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">Well Permit #</div>
                  <div class="job-info-value">${job.wellPermitNumber || 'Not provided'}</div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">Status</div>
                  <div class="job-info-value">
                    <span class="status-badge ${statusClass}">${statusText}</span>
                  </div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">Scheduled</div>
                  <div class="job-info-value">${job.scheduledDate ? new Date(job.scheduledDate).toLocaleString() : 'Not set'}</div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">Will Be Present</div>
                  <div class="job-info-value">${job.willBePresent === 'yes' ? 'Yes' : job.willBePresent === 'no' ? 'No' : 'Not specified'}</div>
                </div>
                <div class="job-info-item">
                  <div class="job-info-label">Assigned Tech</div>
                  <div class="job-info-value">${assignedTechDisplay}</div>
                </div>
                ${job.willBePresent === 'no' && job.accessInstructions 
                  ? `<div class="job-info-item" style="display:flex;align-items:flex-start;gap:0.5rem;">
                      <div style="flex:1;">
                        <div class="job-info-label">Access Instructions</div>
                        <div class="job-info-value" style="white-space:pre-wrap;word-break:break-word">${job.accessInstructions}</div>
                      </div>
                      ${job.notes ? `<button class="notes-btn" onmouseenter="showNotesPopup(event, '${jobId.replace(/'/g, "\\'")}', ${JSON.stringify(job.notes || '').replace(/"/g, '&quot;').replace(/\n/g, '\\n')})" onmouseleave="hideNotesPopup(event)" style="background:#dc2626;color:white;border:none;padding:0.4rem 0.8rem;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;white-space:nowrap;position:relative;align-self:flex-start;">üìù Note</button>` : ''}
                    </div>`
                  : job.notes 
                    ? `<div class="job-info-item" style="display:flex;align-items:flex-start;gap:0.5rem;">
                        <div style="flex:1;">
                          <div class="job-info-label">Access Instructions</div>
                          <div class="job-info-value">Not specified</div>
                        </div>
                        <button class="notes-btn" onmouseenter="showNotesPopup(event, '${jobId.replace(/'/g, "\\'")}', ${JSON.stringify(job.notes || '').replace(/"/g, '&quot;').replace(/\n/g, '\\n')})" onmouseleave="hideNotesPopup(event)" style="background:#dc2626;color:white;border:none;padding:0.4rem 0.8rem;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;white-space:nowrap;position:relative;align-self:flex-start;">üìù Note</button>
                      </div>`
                    : ''
                }
              </div>
              <div class="job-actions">
                <div style="display:flex;gap:1rem;align-items:center;flex:1;flex-wrap:wrap">
                  <div style="display:flex;gap:1rem;align-items:center;flex:1">
                    <label style="font-weight:600;color:var(--navy);white-space:nowrap">Update Status:</label>
                    <select id="statusSelect_${jobId}" style="padding:0.5rem;border:2px solid #ddd;border-radius:6px;flex:1;max-width:200px" onchange="updateJobStatus('${jobId}', this.value)">
                      <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                      <option value="awaiting-payment" ${status === 'awaiting-payment' ? 'selected' : ''}>Awaiting Payment</option>
                      <option value="complete" ${status === 'complete' || status === 'completed' ? 'selected' : ''}>Complete</option>
                    </select>
                  </div>
                  <div style="display:flex;gap:1rem;align-items:center;flex:1;min-width:200px">
                    <label style="font-weight:600;color:var(--navy);white-space:nowrap">Assign Tech:</label>
                    <select id="techSelect_${jobId}" style="padding:0.5rem;border:2px solid #ddd;border-radius:6px;flex:1" onchange="updateJobTech('${jobId}', this.value)">
                      <option value="">None</option>
                      ${allTechs.filter(t => t.active !== false).map(tech => 
                        `<option value="${tech.id}" ${job.assignedTechId === tech.id ? 'selected' : ''}>${tech.name}</option>`
                      ).join('')}
                    </select>
                  </div>
                </div>
                ${hasReport 
                  ? `<a href="admin-report-preview.html?reportId=${report.id}" class="btn-create-report" style="background:var(--brown)">View Report</a>`
                  : `<a href="admin-job-detail.html?jobId=${jobId}" class="btn-create-report">Create Report</a>`
                }
                ${!job.archived 
                  ? `<button onclick="archiveJob('${jobId}')" style="background:#666;color:white;padding:0.6rem 1.2rem;border:none;border-radius:6px;font-weight:600;cursor:pointer;white-space:nowrap">Archive</button>`
                  : `<button onclick="unarchiveJob('${jobId}')" style="background:var(--green);color:white;padding:0.6rem 1.2rem;border:none;border-radius:6px;font-weight:600;cursor:pointer;white-space:nowrap">Unarchive</button>`
                }
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading jobs:', error);
        const emptyState = document.getElementById('emptyState');
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
          <h2>Error Loading Jobs</h2>
          <p>${error.message || 'Failed to load jobs. Please check if the server is running.'}</p>
        `;
      }
    }

    async function updateJobTech(jobId, techId) {
      try {
        console.log('üîÑ updateJobTech called with jobId:', jobId, 'techId:', techId);
        const job = allJobs.find(j => j.id === jobId);
        if (!job) {
          console.error('‚ùå Job not found in allJobs. Job ID:', jobId);
          console.error('Available job IDs:', allJobs.map(j => j.id).slice(0, 5));
          alert('Job not found');
          return;
        }

        console.log('üìù Updating job with assignedTechId:', techId || null);
        // Only send the field we're updating
        await window.jobsAPI.update(jobId, {
          assignedTechId: techId || null
        });

        console.log('‚úÖ Tech assignment updated successfully');
        // Reload jobs to refresh display
        loadJobs();
      } catch (error) {
        console.error('‚ùå Error updating job tech:', error);
        console.error('Error details:', error.message, error.stack);
        alert('Failed to update tech assignment: ' + error.message);
        // Reload jobs to revert the dropdown
        loadJobs();
      }
    }

    async function updateJobStatus(jobId, newStatus) {
      try {
        const job = await window.jobsAPI.getById(jobId);
        const updateData = {
          ...job,
          status: newStatus
        };
        if (newStatus === 'complete') {
          updateData.completedAt = new Date().toISOString();
        }
        await window.jobsAPI.update(jobId, updateData);
        
        // Reload jobs to reflect the change
        loadJobs();
        
        // Show confirmation
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:100px;right:2rem;background:var(--green);color:white;padding:1rem 2rem;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10000';
        toast.textContent = 'Status updated successfully!';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2000);
      } catch (error) {
        console.error('Error updating job status:', error);
        alert('Failed to update job status: ' + error.message);
      }
    }

    async function archiveJob(jobId) {
      if (!confirm('Are you sure you want to archive this job? It will be moved to the Archived section.')) {
        return;
      }
      
      try {
        const job = await window.jobsAPI.getById(jobId);
        const updateData = {
          ...job,
          archived: true,
          archivedAt: new Date().toISOString()
        };
        await window.jobsAPI.update(jobId, updateData);
        
        // Reload jobs to reflect the change
        loadJobs();
        
        // Show confirmation
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:100px;right:2rem;background:var(--green);color:white;padding:1rem 2rem;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10000';
        toast.textContent = 'Job archived successfully!';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2000);
      } catch (error) {
        console.error('Error archiving job:', error);
        alert('Failed to archive job: ' + error.message);
      }
    }

    async function unarchiveJob(jobId) {
      if (!confirm('Are you sure you want to unarchive this job? It will be moved back to the active jobs list.')) {
        return;
      }
      
      try {
        const job = await window.jobsAPI.getById(jobId);
        const updateData = {
          ...job,
          archived: false,
          archivedAt: null
        };
        await window.jobsAPI.update(jobId, updateData);
        
        // Reload jobs to reflect the change
        loadJobs();
        
        // Show confirmation
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:100px;right:2rem;background:var(--green);color:white;padding:1rem 2rem;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10000';
        toast.textContent = 'Job unarchived successfully!';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2000);
      } catch (error) {
        console.error('Error unarchiving job:', error);
        alert('Failed to unarchive job: ' + error.message);
      }
    }
    
    // Make functions globally accessible
    window.archiveJob = archiveJob;
    window.unarchiveJob = unarchiveJob;

    // Export all data (jobs and reports) to JSON file
    async function exportData() {
      try {
        const jobs = await window.jobsAPI.getAll();
        const reports = await window.reportsAPI.getAll();
      
      const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        jobs: jobs,
        reports: reports
      };
      
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `well-testing-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // Show success toast
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:100px;right:2rem;background:var(--green);color:white;padding:1rem 2rem;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10000';
        toast.textContent = 'Data exported successfully!';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2000);
      } catch (error) {
        console.error('Error exporting data:', error);
        alert('Failed to export data: ' + error.message);
      }
    }

    // Import data from JSON file
    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          if (!importData.jobs || !Array.isArray(importData.jobs)) {
            throw new Error('Invalid backup file format');
          }
          
          // Confirm before importing
          const confirmMsg = `This will import ${importData.jobs.length} job(s) and ${(importData.reports || []).length} report(s). This will replace your current data. Continue?`;
          if (!confirm(confirmMsg)) {
            event.target.value = ''; // Reset file input
            return;
          }
          
          // Merge with existing data (keep existing if IDs match, add new ones)
          const existingJobs = await window.jobsAPI.getAll();
          const existingReports = await window.reportsAPI.getAll();
          
          // Merge jobs - keep existing if ID matches, otherwise add new
          const existingJobIds = new Set(existingJobs.map(j => j.id));
          for (const job of importData.jobs) {
            if (!existingJobIds.has(job.id)) {
              await window.jobsAPI.create(job);
            }
          }
          
          // Merge reports - keep existing if ID matches, otherwise add new
          const existingReportIds = new Set(existingReports.map(r => r.id));
          for (const report of (importData.reports || [])) {
            if (!existingReportIds.has(report.id)) {
              await window.reportsAPI.create(report);
            }
          }
          
          // Reload jobs
          loadJobs();
          
          // Show success toast
          const toast = document.createElement('div');
          toast.style.cssText = 'position:fixed;top:100px;right:2rem;background:var(--green);color:white;padding:1rem 2rem;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10000';
          toast.textContent = 'Data imported successfully!';
          document.body.appendChild(toast);
          setTimeout(() => {
            toast.remove();
          }, 2000);
          
          // Reset file input
          event.target.value = '';
        } catch (error) {
          alert('Error importing data: ' + error.message);
          event.target.value = ''; // Reset file input
        }
      };
      reader.readAsText(file);
    }

    // Initialize: load techs first, then jobs
    (async function() {
      await loadTechs();
      loadJobs();
    })();

    // Refresh jobs every 30 seconds
    setInterval(async function() {
      await loadTechs();
      loadJobs();
    }, 30000);
    
    // Re-render tech filters when techs are loaded
    if (typeof renderTechFilters === 'function') {
      // This will be called after loadTechs completes
    }
    
    // Notes popup functions for hover
    window.showNotesPopup = function(event, jobId, notes) {
      // Remove any existing popup
      const existingPopup = document.getElementById('notesPopup');
      if (existingPopup) {
        existingPopup.remove();
      }
      
      // Escape HTML and handle newlines
      const escapedNotes = String(notes || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      
      // Create popup
      const popup = document.createElement('div');
      popup.id = 'notesPopup';
      popup.style.cssText = 'position:fixed;background:white;border:2px solid #1e3a5f;border-radius:6px;padding:0.25rem 0.6rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;max-width:240px;word-wrap:break-word;white-space:pre-wrap;';
      popup.innerHTML = `
        <div style="font-weight:600;color:#1e3a5f;margin-bottom:0.15rem;font-size:0.8rem;margin-top:0;">Note:</div>
        <div style="color:#333;font-size:0.8rem;line-height:1.3;margin:0;padding:0;">${escapedNotes.replace(/\n/g, '<br>')}</div>
      `;
      
      // Position popup near the button using getBoundingClientRect (viewport coordinates)
      const button = event.target;
      const rect = button.getBoundingClientRect();
      
      // Use fixed positioning relative to viewport
      let topPos = rect.bottom + 5;
      let leftPos = rect.left;
      
      // Adjust if popup would go off screen
      if (leftPos + 240 > window.innerWidth) {
        leftPos = window.innerWidth - 250; // 240px width + 10px margin
      }
      if (topPos + 150 > window.innerHeight) {
        topPos = rect.top - 150; // Show above button instead
        if (topPos < 5) topPos = 5; // Ensure it's not off top of screen
      }
      
      popup.style.top = topPos + 'px';
      popup.style.left = leftPos + 'px';
      
      document.body.appendChild(popup);
      
      // Keep popup visible when hovering over it
      popup.onmouseenter = function() {
        // Keep visible
      };
      popup.onmouseleave = function() {
        popup.remove();
      };
    };
    
    window.hideNotesPopup = function(event) {
      // Small delay to allow moving to popup
      setTimeout(() => {
        const popup = document.getElementById('notesPopup');
        if (popup) {
          // Check if mouse moved to popup
          const relatedTarget = event.relatedTarget;
          if (relatedTarget && (relatedTarget.id === 'notesPopup' || popup.contains(relatedTarget))) {
            return; // Mouse moved to popup, keep it visible
          }
          // Otherwise hide it
          popup.remove();
        }
      }, 150);
    };

    // Admin menu dropdown toggle
    function toggleAdminMenu() {
      const dropdown = document.getElementById('adminMenuDropdown');
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }

    // Close dropdown when clicking outside
    window.addEventListener('click', function(event) {
      const dropdown = document.getElementById('adminMenuDropdown');
      const menuBtn = document.querySelector('.admin-menu-btn');
      if (dropdown && menuBtn && !menuBtn.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Make toggleAdminMenu globally accessible
    window.toggleAdminMenu = toggleAdminMenu;

    // Address editing functions
    function editAddress(jobId) {
      const editForm = document.getElementById(`addressEditForm_${jobId}`);
      if (editForm) {
        editForm.classList.add('active');
      }
    }

    function cancelEditAddress(jobId) {
      const editForm = document.getElementById(`addressEditForm_${jobId}`);
      if (editForm) {
        editForm.classList.remove('active');
        // Reset values to original
        loadJobs();
      }
    }

    async function saveAddress(jobId) {
      const propertyAddress = document.getElementById(`editPropertyAddress_${jobId}`).value.trim();
      const city = document.getElementById(`editCity_${jobId}`).value.trim();
      const zip = document.getElementById(`editZip_${jobId}`).value.trim();

      try {
        const job = await window.jobsAPI.getById(jobId);
        const updateData = {
          ...job,
          address: propertyAddress || null, // Save to 'address' field (database field name)
          propertyAddress: propertyAddress || null, // Also keep for backward compatibility
          city: city || null,
          zip: zip || null
        };
        
        await window.jobsAPI.update(jobId, updateData);
        
        // Hide edit form
        const editForm = document.getElementById(`addressEditForm_${jobId}`);
        if (editForm) {
          editForm.classList.remove('active');
        }
        
        // Reload jobs to show updated address
        loadJobs();
        
        // Show success toast
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:100px;right:2rem;background:var(--green);color:white;padding:1rem 2rem;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:10000';
        toast.textContent = 'Address updated successfully!';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 2000);
      } catch (error) {
        console.error('Error updating address:', error);
        alert('Failed to update address: ' + error.message);
      }
    }

    // Make functions globally accessible
    window.editAddress = editAddress;
    window.saveAddress = saveAddress;
    window.cancelEditAddress = cancelEditAddress;
    
  </script>
</body>
</html>

