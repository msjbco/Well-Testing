<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Preview | Peak to Plains Well Testing</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Hide any text content in w3-include-html div before header loads */
    [w3-include-html] {
      font-size: 0 !important;
      line-height: 0 !important;
      color: transparent !important;
      overflow: hidden !important;
      visibility: hidden !important;
      height: 0 !important;
      min-height: 0 !important;
    }
    [w3-include-html]::before,
    [w3-include-html]::after {
      content: none !important;
      display: none !important;
    }
    [w3-include-html] > * {
      font-size: initial;
      line-height: normal;
      color: initial;
      visibility: visible;
    }
    [w3-include-html] header {
      visibility: visible !important;
      height: auto !important;
      min-height: 80px !important;
    }
    
    .preview-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }
    .preview-header {
      background: var(--navy);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      text-align: center;
    }
    .preview-header h1 {
      color: white;
      margin: 0 0 1rem 0;
    }
    .preview-actions {
      position: fixed;
      right: 2rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      z-index: 1000;
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .btn-secondary {
      background: var(--brown);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      cursor: pointer;
      text-align: center;
      white-space: nowrap;
      transition: background 0.3s ease;
    }
    .btn-secondary:hover {
      background: #6d5635;
    }
    .btn-edit {
      background: var(--green);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      text-align: center;
      white-space: nowrap;
      transition: background 0.3s ease;
    }
    .btn-edit:hover {
      background: #1f4d3a;
    }
    .preview-actions .btn {
      text-align: center;
      white-space: nowrap;
    }
    .btn-receipt {
      background: var(--navy);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      cursor: pointer;
      text-align: center;
      white-space: nowrap;
      transition: background 0.3s ease;
    }
    .btn-receipt:hover {
      background: #1a3a5c;
    }
    /* Receipt Modal */
    .receipt-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }
    .receipt-modal.active {
      display: flex;
    }
    .receipt-modal-content {
      background: white;
      padding: 2.5rem;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .receipt-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #ddd;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .receipt-modal-close:hover {
      background: #bbb;
    }
    .receipt-modal-content h2 {
      color: var(--navy);
      margin: 0 0 2rem 0;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--green);
    }
    .receipt-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    .receipt-table thead {
      border-bottom: 2px solid #ddd;
    }
    .receipt-table th {
      text-align: left;
      padding: 1rem;
      font-weight: 600;
      color: var(--navy);
    }
    .receipt-table td {
      padding: 1rem;
      border-bottom: 1px solid #eee;
    }
    .receipt-table tbody tr:last-child td {
      border-bottom: none;
    }
    .receipt-table tfoot {
      border-top: 2px solid #ddd;
    }
    .receipt-table tfoot td {
      padding: 1rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }
    .receipt-table .amount {
      text-align: right;
    }
    .report-section {
      background: white;
      padding: 2.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .report-section h2 {
      color: var(--navy);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--green);
    }
    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .report-item {
      display: flex;
      flex-direction: column;
    }
    .report-label {
      color: var(--gray);
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .report-value {
      color: var(--navy);
      font-size: 1.1rem;
      font-weight: 600;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    .photo-item {
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .photo-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .photo-caption {
      padding: 0.8rem;
      background: #f9f9f9;
      font-size: 0.9rem;
      color: var(--navy);
      font-style: italic;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .flow-table {
      width: 90%;
      border-collapse: collapse;
      margin: 1.5rem auto;
    }
    .flow-table th,
    .flow-table td {
      padding: 0.8rem;
      text-align: left;
      border: 1px solid #ddd;
    }
    .flow-table th {
      background: var(--navy);
      color: white;
      font-weight: 600;
    }
    .recommendations-content {
      padding: 1.5rem;
      background: #f9f9f9;
      border-radius: 8px;
      line-height: 1.8;
    }
    .recommendations-content h1,
    .recommendations-content h2,
    .recommendations-content h3 {
      color: var(--navy);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .recommendations-content ul,
    .recommendations-content ol {
      margin-left: 2rem;
      margin-bottom: 1rem;
    }
    .recommendations-content p {
      margin-bottom: 1rem;
    }
    
    /* Responsive adjustments for action buttons */
    @media (max-width: 1024px) {
      .preview-actions {
        right: 1rem;
        padding: 1rem;
      }
      .btn-secondary,
      .btn-edit,
      .preview-actions .btn {
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 768px) {
      .preview-actions {
        position: relative;
        right: auto;
        top: auto;
        transform: none;
        flex-direction: row;
        justify-content: center;
        margin: 2rem 0;
        box-shadow: none;
        background: transparent;
        padding: 0;
      }
    }
    
    @media print {
      /* Hide navigation header */
      .site-header,
      [w3-include-html],
      header {
        display: none !important;
      }
      
      /* Remove body padding that was for fixed header */
      body {
        padding-top: 0 !important;
      }
      
      .preview-actions {
        display: none;
      }
      .preview-header {
        page-break-after: avoid;
      }
      .report-section {
        page-break-inside: avoid;
      }
      
      /* Flow & Yield Test section - keep table, results, recovery, and % change note together */
      .flow-yield-section {
        page-break-inside: avoid;
      }
      .flow-table {
        font-size: 0.85rem;
      }
      .flow-table th,
      .flow-table td {
        padding: 0.5rem;
      }
      .flow-table-large {
        font-size: 0.75rem;
      }
      .flow-table-large th,
      .flow-table-large td {
        padding: 0.4rem;
      }
      .flow-results-summary {
        page-break-inside: avoid;
      }
      .flow-recovery-note {
        page-break-inside: avoid;
        page-break-before: avoid;
      }
      .flow-percent-note {
        page-break-inside: avoid;
        page-break-before: avoid;
        page-break-after: avoid;
      }
      /* If table is large (>12 rows), move results to next page */
      .flow-results-new-page {
        page-break-before: always;
      }
      
      /* System Equipment, Water Quality, and Recommendations always start on new page */
      .system-equipment-section {
        page-break-before: always;
      }
      .water-quality-section {
        page-break-before: always;
      }
      .recommendations-section {
        page-break-before: always;
      }
      
      /* Prevent photo items from breaking across pages */
      .photo-item {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        margin-bottom: 1rem;
      }
      .photo-item img {
        page-break-after: avoid !important;
        break-after: avoid !important;
      }
      .photo-caption {
        page-break-before: avoid !important;
        break-before: avoid !important;
      }
      
      /* GPS Coordinates link styling for print */
      .report-value a {
        color: var(--navy) !important;
        text-decoration: none !important;
      }
      
      /* Well head map styling for print */
      #wellHeadMap_* {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* Ensure content starts at top */
      .preview-container {
        padding-top: 0;
        margin-top: 0;
      }
    }
  </style>
</head>
<body>
  <!-- INSERT HEADER -->
  <div w3-include-html="header.html"></div>
  
  <!-- Check authentication -->
  <script>
    if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
      window.location.href = 'admin-login.html';
    }
  </script>

  <div class="preview-container">
    <div class="preview-header">
      <h1>Well Test Report</h1>
      <p id="reportDate"></p>
    </div>

    <div id="reportContent">
      <!-- Report content will be loaded here -->
    </div>

    <div class="preview-actions">
      <a href="admin-dashboard.html" class="btn-secondary">Back to Dashboard</a>
      <a href="#" id="editReportBtn" class="btn-edit">Edit Report</a>
      <button onclick="window.print()" class="btn">Print Report</button>
      <button onclick="showReceiptModal()" class="btn-receipt">View Receipt</button>
    </div>

    <!-- Receipt Modal -->
    <div class="receipt-modal" id="receiptModal" onclick="closeReceiptModal(event)">
      <div class="receipt-modal-content" onclick="event.stopPropagation()">
        <button class="receipt-modal-close" onclick="closeReceiptModal()">&times;</button>
        <div id="receiptModalBody">
          <!-- Receipt content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script src="api.js"></script>
  <!-- Leaflet for map display -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Hide the include div initially
    document.addEventListener('DOMContentLoaded', function() {
      const includeDiv = document.querySelector('[w3-include-html]');
      if (includeDiv) {
        includeDiv.style.display = 'none';
      }
      
      w3.includeHTML(function() {
        // Show the div after header loads
        if (includeDiv) {
          includeDiv.style.display = 'block';
        }
      });
    });
  </script>
  <script>
    // Get report ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('reportId');
    const jobId = urlParams.get('jobId');

    if (!reportId) {
      document.getElementById('reportContent').innerHTML = `
        <div class="report-section">
          <p style="color:var(--gray);text-align:center">No report ID provided.</p>
        </div>
      `;
    } else {
      // Function to calculate receipt (defined before loadReport so it can be used)
      function calculateReceipt(job, data) {
        const lineItems = [];
        let total = 0;

        // Check if cistern + inspection (no flow test charge)
        const hasCistern = job && job.hasCistern === 'yes';
        const hasInspection = job && job.equipmentInspection === 'yes';
        const isCisternInspection = hasCistern && hasInspection;

        // Flow Test - $449 (unless cistern + inspection)
        if (!isCisternInspection) {
          lineItems.push({ description: 'Flow Rate Test', amount: 449 });
          total += 449;
        }

        // Equipment Inspection - $150 (if cistern + inspection)
        if (isCisternInspection) {
          lineItems.push({ description: 'Well Equipment Inspection', amount: 150 });
          total += 150;
        }

        // Water Quality Tests - $50 each (only if value exists)
        // Check for coliform or ecoli (bacteria test)
        const coliformValue = data.coliform || data.coliformEcoli;
        const ecoliValue = data.ecoli;
        if (coliformValue && (coliformValue === 'Present' || coliformValue === 'Absent' || coliformValue === 'present' || coliformValue === 'absent')) {
          lineItems.push({ description: 'Coliform / E.coli Test', amount: 50 });
          total += 50;
        } else if (ecoliValue && (ecoliValue === 'Present' || ecoliValue === 'Absent' || ecoliValue === 'present' || ecoliValue === 'absent')) {
          lineItems.push({ description: 'Coliform / E.coli Test', amount: 50 });
          total += 50;
        }
        
        // Check for other water quality tests
        const waterQualityTests = [
          { field: 'nitrate', name: 'Nitrate Test' },
          { field: 'arsenic', name: 'Arsenic Test' },
          { field: 'lead', name: 'Lead Test' },
          { field: 'iron', name: 'Iron Test' },
          { field: 'manganese', name: 'Manganese Test' },
          { field: 'hardness', name: 'Hardness Test' },
          { field: 'ph', name: 'pH Test' },
          { field: 'tds', name: 'TDS Test' }
        ];

        waterQualityTests.forEach(test => {
          const value = data[test.field];
          // For numeric fields, check if value exists and is not empty
          if (value !== null && value !== undefined && value !== '') {
            lineItems.push({ description: test.name, amount: 50 });
            total += 50;
          }
        });

        return { lineItems, total };
      }

      // Load report data
      async function loadReport() {
        try {
          let report;
          try {
            // Try loading by reportId first
            if (reportId) {
              console.log('Loading report with ID:', reportId);
              report = await window.reportsAPI.getById(reportId);
              console.log('Report loaded from API by ID:', report);
            }
          } catch (error) {
            console.error('Error loading report by ID from API:', error);
            console.error('Error details:', error.message, error.status);
            console.error('Full error object:', error);
            
            // Always try loading by jobId if we have one (regardless of error type)
            if (jobId) {
              console.log('Trying to load report by jobId as fallback:', jobId);
              try {
                report = await window.reportsAPI.getByJobId(jobId);
                console.log('Report loaded from API by jobId:', report);
                // If we got a report by jobId, update the reportId in the URL
                if (report && report.id) {
                  const newUrl = new URL(window.location);
                  newUrl.searchParams.set('reportId', report.id);
                  window.history.replaceState({}, '', newUrl);
                }
              } catch (jobIdError) {
                console.error('Error loading report by jobId:', jobIdError);
                console.error('JobId error details:', jobIdError.message, jobIdError.status);
                // If both fail, show error
                document.getElementById('reportContent').innerHTML = `
                  <div class="report-section">
                    <p style="color:var(--gray);text-align:center">Report not found. The report may not have been saved yet.</p>
                    <p style="color:var(--gray);text-align:center;margin-top:1rem">
                      <a href="admin-job-detail.html?jobId=${jobId}" style="color:var(--green);text-decoration:underline">Go to job detail to create report</a>
                    </p>
                    <p style="color:var(--gray);text-align:center;margin-top:1rem;font-size:0.9rem">
                      Debug: Report ID: ${reportId || 'none'}, Job ID: ${jobId || 'none'}
                    </p>
                  </div>
                `;
                return;
              }
            } else if (error.status === 404 || !error.status) {
              // No jobId to try, show error
              document.getElementById('reportContent').innerHTML = `
                <div class="report-section">
                  <p style="color:var(--gray);text-align:center">Report not found. The report may not have been saved yet.</p>
                </div>
              `;
              return;
            } else {
              // Network error - try localStorage fallback
              console.warn('API unavailable, trying localStorage fallback:', error);
              const reports = JSON.parse(localStorage.getItem('wellReports') || '[]');
              report = reports.find(r => r.id === reportId);
              if (!report) {
                throw new Error('Report not found in localStorage');
              }
            }
          }
          
          // Handle case where report doesn't have data property (new format from API)
          if (!report) {
            document.getElementById('reportContent').innerHTML = `
              <div class="report-section">
                <p style="color:var(--gray);text-align:center">Report not found.</p>
              </div>
            `;
            return;
          }
          
          // If report doesn't have .data property, create it from the report itself
          // Handle both formats: reports with 'data' wrapper and flat reports
          if (!report.data) {
            report.data = {
              flowReadings: report.flow_readings || report.flowReadings || [],
              waterQuality: report.water_quality || report.waterQuality || {},
              photos: report.photos || [],
              notes: report.notes || '',
              recommendations: report.recommendations || '',
              wellBasics: report.well_basics || report.wellBasics || {},
              systemEquipment: report.system_equipment || report.systemEquipment || {},
            };
          }
          
          // Also ensure flat fields are available on report for direct access
          // This handles reports that come from /api/reports (flat format)
          if (!report.water_quality && !report.waterQuality) {
            report.water_quality = report.data?.waterQuality || report.data?.water_quality || {};
            report.waterQuality = report.water_quality;
          }
          if (!report.well_basics && !report.wellBasics) {
            report.well_basics = report.data?.wellBasics || report.data?.well_basics || {};
            report.wellBasics = report.well_basics;
          }
          if (!report.system_equipment && !report.systemEquipment) {
            report.system_equipment = report.data?.systemEquipment || report.data?.system_equipment || {};
            report.systemEquipment = report.system_equipment;
          }

          // Load job data
          let job = null;
          try {
            job = await window.jobsAPI.getById(report.jobId);
            console.log('‚úÖ Job loaded successfully:', job);
            console.log('   Job address:', job?.address || job?.propertyAddress);
            console.log('   Job county:', job?.county);
            console.log('   Job client_name:', job?.client_name || job?.name);
          } catch (error) {
            console.warn('Could not load job data from API, trying localStorage:', error);
            // Fallback to localStorage
            const jobs = JSON.parse(localStorage.getItem('scheduledJobs') || '[]');
            job = jobs.find(j => j.id === report.jobId);
            if (job) {
              console.log('‚úÖ Job found in localStorage:', job);
            } else {
              console.error('‚ùå Job not found in localStorage either');
            }
          }

          console.log('üìä Final job object before building HTML:', job);
          console.log('   Has job?', !!job);
          console.log('   Job keys:', job ? Object.keys(job) : 'null');

          // Handle both report formats:
          // 1. Reports with 'data' property (from /api/reports/:id)
          // 2. Flat reports (from /api/reports fallback)
          const data = report.data || {};
          
          // Extract water quality from multiple possible locations
          // Check report first (flat format from /api/reports), then data (nested format)
          let waterQuality = report.water_quality || report.waterQuality || data.waterQuality || data.water_quality || {};
          
          // Extract well basics
          let wellBasics = report.well_basics || report.wellBasics || data.wellBasics || data.well_basics || {};
          
          // Extract system equipment
          let systemEquipment = report.system_equipment || report.systemEquipment || data.systemEquipment || data.system_equipment || {};
          
          console.log('üîç Data extraction check:', {
            'report.water_quality': report.water_quality,
            'report.waterQuality': report.waterQuality,
            'data.waterQuality': data.waterQuality,
            'final waterQuality': waterQuality,
            'waterQuality keys': Object.keys(waterQuality),
            'waterQuality full object': JSON.stringify(waterQuality),
            'report.water_quality full': JSON.stringify(report.water_quality || {}),
            'report.waterQuality full': JSON.stringify(report.waterQuality || {}),
            'data.waterQuality full': JSON.stringify(data.waterQuality || {}),
            'report has data property': !!report.data,
            'data keys': Object.keys(data),
            'report top level keys': Object.keys(report).filter(k => k.includes('water') || k.includes('quality') || k.includes('coliform') || k.includes('nitrate')),
          });
          
          // Merge water quality into data for receipt calculation
          // This allows the receipt calculation to access water quality fields directly
          const dataForReceipt = {
            ...data,
            ...waterQuality, // Merge water quality fields into data
          };
          
          console.log('üìä Data structure:', {
            hasWaterQuality: !!data.waterQuality,
            hasWellBasics: !!data.wellBasics,
            hasSystemEquipment: !!data.systemEquipment,
            waterQualityKeys: Object.keys(waterQuality),
            wellBasicsKeys: Object.keys(wellBasics),
            waterQualityObject: waterQuality,
            dataWaterQuality: data.waterQuality,
            fullDataKeys: Object.keys(data),
            reportKeys: Object.keys(report),
          });

        // Load tech data if job has assigned tech
        let techName = null;
        if (job && job.assignedTechId) {
          try {
            const techs = await window.techsAPI.getAll();
            const tech = techs.find(t => t.id === job.assignedTechId);
            if (tech) {
              techName = tech.name;
            }
          } catch (error) {
            console.warn('Could not load tech data:', error);
          }
        }

        // Set report date and tech name
        const reportDate = new Date(report.createdAt);
        let reportDateText = `Generated: ${reportDate.toLocaleDateString()} at ${reportDate.toLocaleTimeString()}`;
        if (techName) {
          reportDateText += ` | Testing Technician: ${techName}`;
        }
        document.getElementById('reportDate').textContent = reportDateText;

        // Set edit button link
        document.getElementById('editReportBtn').href = `admin-job-detail.html?jobId=${report.jobId}&reportId=${reportId}&edit=true`;

        // Build report HTML
        let reportHTML = '';

        // Job Information
        const jobAddress = job ? (job.address || job.propertyAddress || 'N/A') : 'N/A';
        const jobCounty = job ? (job.county || 'N/A') : 'N/A';
        const jobClientName = job ? (job.client_name || job.name || 'N/A') : 'N/A';
        
        console.log('üèóÔ∏è Building job info HTML with:', {
          address: jobAddress,
          county: jobCounty,
          clientName: jobClientName
        });
        
        reportHTML += `
          <div class="report-section">
            <h2>Job Information</h2>
            <div class="report-grid">
              <div class="report-item">
                <div class="report-label">Property Address</div>
                <div class="report-value">${jobAddress}</div>
              </div>
              <div class="report-item">
                <div class="report-label">County</div>
                <div class="report-value">${jobCounty}</div>
              </div>
              <div class="report-item">
                <div class="report-label">Client Name</div>
                <div class="report-value">${jobClientName}</div>
              </div>
              <div class="report-item">
                <div class="report-label">Well Permit #</div>
                <div class="report-value">${data.wellPermit || data.wellBasics?.wellPermit || 'Not provided'}</div>
              </div>
            </div>
          </div>
        `;

        // Photos
        if (report.photos && report.photos.length > 0) {
          reportHTML += `
            <div class="report-section">
              <h2>Photos</h2>
              <div class="photo-grid">
          `;
          report.photos.forEach(photo => {
            if (photo.url) {
              reportHTML += `
                <div class="photo-item">
                  <img src="${photo.url}" alt="${photo.caption || 'Photo'}">
                  <div class="photo-caption">${photo.caption || 'Photo'}</div>
                </div>
              `;
            }
          });
          reportHTML += `
              </div>
            </div>
          `;
        }

        // Well Basics - check both data and wellBasics
        const totalDepth = data.totalDepth || wellBasics.totalDepth;
        const casingDepth = data.casingDepth || wellBasics.casingDepth;
        const staticWaterLevel = data.staticWaterLevel || wellBasics.staticWaterLevel;
        const gpsLat = data.gpsLat || wellBasics.gpsLat;
        const gpsLong = data.gpsLong || wellBasics.gpsLong;
        const coordinates = data.coordinates || wellBasics.coordinates;
        
        if (totalDepth || casingDepth || staticWaterLevel || gpsLat) {
          reportHTML += `
            <div class="report-section">
              <h2>Well Basics</h2>
              <div class="report-grid">
          `;
          if (totalDepth) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Total Depth</div>
                <div class="report-value">${totalDepth} ft</div>
              </div>
            `;
          }
          if (casingDepth) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Casing Depth</div>
                <div class="report-value">${casingDepth} ft</div>
              </div>
            `;
          }
          if (staticWaterLevel) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Static Water Level</div>
                <div class="report-value">${staticWaterLevel} ft</div>
              </div>
            `;
          }
          // Get coordinates from coordinates field or GPS fields
          let mapLat = null;
          let mapLong = null;
          let coordinatesText = '';
          
          if (coordinates) {
            // Parse coordinates field (format: "lat, long" or "lat long")
            const parts = coordinates.split(/[,\s]+/).filter(p => p.trim());
            if (parts.length >= 2) {
              mapLat = parseFloat(parts[0]);
              mapLong = parseFloat(parts[1]);
              coordinatesText = `${mapLat}, ${mapLong}`;
            }
          } else if (gpsLat && gpsLong) {
            mapLat = parseFloat(gpsLat);
            mapLong = parseFloat(gpsLong);
            coordinatesText = `${mapLat}, ${mapLong}`;
          }
          
          if (mapLat && mapLong && !isNaN(mapLat) && !isNaN(mapLong)) {
            const mapsUrl = `https://www.google.com/maps?q=${mapLat},${mapLong}`;
            reportHTML += `
              <div class="report-item" style="grid-column:1/-1">
                <div class="report-label">GPS Coordinates</div>
                <div class="report-value">
                  <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" style="color:var(--green);text-decoration:underline;font-weight:600">
                    ${coordinatesText}
                  </a>
                </div>
              </div>
              <div class="report-item" style="grid-column:1/-1;margin-top:1rem">
                <div class="report-label">Well Head Location Map</div>
                <div id="wellHeadMap_${report.id || 'map'}" style="width:100%;height:400px;border:2px solid #ddd;border-radius:8px;margin-top:0.5rem"></div>
              </div>
            `;
            
            // Store coordinates for map initialization
            if (!window.mapCoordinates) window.mapCoordinates = {};
            const mapId = report.id || 'map';
            window.mapCoordinates[mapId] = { lat: mapLat, lng: mapLong, reportId: report.id };
          } else if (gpsLat && gpsLong) {
            // Show link even if coordinates can't be parsed for map
            const mapsUrl = `https://www.google.com/maps?q=${gpsLat},${gpsLong}`;
            reportHTML += `
              <div class="report-item">
                <div class="report-label">GPS Coordinates</div>
                <div class="report-value">
                  <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" style="color:var(--green);text-decoration:underline;font-weight:600">
                    ${gpsLat}, ${gpsLong}
                  </a>
                </div>
              </div>
            `;
          }
          reportHTML += `
              </div>
            </div>
          `;
        }

        // Flow & Yield Test
        console.log('üìä Flow readings data:', {
          hasFlowReadings: !!data.flowReadings,
          flowReadingsLength: data.flowReadings?.length || 0,
          flowReadings: data.flowReadings
        });
        
        if (data.flowReadings && data.flowReadings.length > 0) {
          // Helper function to format numbers with commas
          function formatNumber(num) {
            if (num >= 1000) {
              return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            }
            return num.toFixed(2);
          }
          
          // Calculate % change for each reading
          const readingsWithPercentChange = data.flowReadings.map((reading, index) => {
            let percentChange = null;
            let percentChangeColor = '#666';
            if (index > 0) {
              const previousGpm = data.flowReadings[index - 1].gpm;
              if (previousGpm && previousGpm !== 0) {
                percentChange = ((reading.gpm - previousGpm) / previousGpm) * 100;
                if (percentChange > 0) {
                  percentChangeColor = '#2e7d32'; // green
                } else if (percentChange < 0) {
                  percentChangeColor = '#d32f2f'; // red
                }
              }
            }
            return { ...reading, percentChange, percentChangeColor };
          });
          
          // Calculate % Change for final 3 readings
          let avgPercentChangeFinal3 = null;
          let avgPercentChangeColor = '#666';
          if (data.flowReadings.length >= 3) {
            const final3 = data.flowReadings.slice(-3);
            let totalPercentChange = 0;
            let validChanges = 0;
            
            for (let i = 1; i < final3.length; i++) {
              const previousGpm = final3[i - 1].gpm;
              const currentGpm = final3[i].gpm;
              if (previousGpm && previousGpm !== 0) {
                const change = ((currentGpm - previousGpm) / previousGpm) * 100;
                totalPercentChange += change;
                validChanges++;
              }
            }
            
            if (validChanges > 0) {
              avgPercentChangeFinal3 = totalPercentChange / validChanges;
              if (avgPercentChangeFinal3 > 0) {
                avgPercentChangeColor = '#2e7d32'; // green
              } else if (avgPercentChangeFinal3 < 0) {
                avgPercentChangeColor = '#d32f2f'; // red
              }
            }
          }
          
          const rowCount = readingsWithPercentChange.length;
          const tableClass = rowCount > 12 ? 'flow-table-large' : 'flow-table';
          const resultsClass = rowCount > 12 ? 'flow-results-summary flow-results-new-page' : 'flow-results-summary';
          
          reportHTML += `
            <div class="report-section flow-yield-section">
              <h2>Flow & Yield Test</h2>
              <table class="${tableClass}">
                <thead>
                  <tr>
                    <th>Time (minutes)</th>
                    <th>GPM Reading</th>
                    <th>% Change</th>
                  </tr>
                </thead>
                <tbody>
          `;
          readingsWithPercentChange.forEach(reading => {
            const percentChangeDisplay = reading.percentChange !== null 
              ? reading.percentChange.toFixed(2) + '%' 
              : '--';
            // Only display if reading has a gpm value (not null/undefined)
            if (reading.gpm !== null && reading.gpm !== undefined) {
              reportHTML += `
                <tr>
                  <td>${reading.time !== null && reading.time !== undefined ? reading.time : '--'}</td>
                  <td>${reading.gpm.toFixed(2)}</td>
                  <td style="color:${reading.percentChangeColor};font-weight:600;text-align:left">${percentChangeDisplay}</td>
                </tr>
              `;
            }
          });
          reportHTML += `
                </tbody>
              </table>
          `;
          if (data.sustainedYield || data.peakFlow || data.averageFlowRate || avgPercentChangeFinal3 !== null) {
            reportHTML += `
              <div class="${resultsClass}" style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1.5rem;padding:1.5rem;background:#f4f0ea;border-radius:8px">
            `;
            if (data.sustainedYield) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">Sustained Yield</div>
                  <div style="color:var(--navy);font-size:1.5rem;font-weight:700">${formatNumber(data.sustainedYield)} GPM</div>
                </div>
              `;
            }
            if (data.peakFlow) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">Peak Flow</div>
                  <div style="color:var(--navy);font-size:1.5rem;font-weight:700">${formatNumber(data.peakFlow)} GPM</div>
                </div>
              `;
            }
            if (data.averageFlowRate) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">Average Flow Rate</div>
                  <div style="color:var(--navy);font-size:1.5rem;font-weight:700">${formatNumber(data.averageFlowRate)} GPM</div>
                </div>
              `;
            }
            if (avgPercentChangeFinal3 !== null) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">% Change (Final 3)</div>
                  <div style="color:${avgPercentChangeColor};font-size:1.5rem;font-weight:700">${avgPercentChangeFinal3.toFixed(2)}%</div>
                </div>
              `;
            }
            if (data.volume12hr) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">Volume Yield (12 hr)</div>
                  <div style="color:var(--navy);font-size:1.5rem;font-weight:700">${formatNumber(data.volume12hr)} gal</div>
                </div>
              `;
            }
            if (data.volume24hr) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">Volume Yield (24 hr)</div>
                  <div style="color:var(--navy);font-size:1.5rem;font-weight:700">${formatNumber(data.volume24hr)} gal</div>
                </div>
              `;
            }
            // Calculate total water discharged during test
            let totalWaterDischarged = 0;
            if (data.flowReadings && data.flowReadings.length > 0) {
              for (let i = 0; i < data.flowReadings.length; i++) {
                const current = data.flowReadings[i];
                const next = data.flowReadings[i + 1];
                if (current.time !== null && current.gpm > 0) {
                  if (next && next.time !== null) {
                    const intervalMinutes = next.time - current.time;
                    totalWaterDischarged += current.gpm * intervalMinutes;
                  } else if (i === data.flowReadings.length - 1) {
                    const avgInterval = data.flowReadings.length > 1 
                      ? (current.time - data.flowReadings[0].time) / (data.flowReadings.length - 1)
                      : 15;
                    totalWaterDischarged += current.gpm * avgInterval;
                  }
                }
              }
            }
            if (totalWaterDischarged > 0) {
              reportHTML += `
                <div style="text-align:center">
                  <div style="color:var(--gray);font-size:0.9rem;margin-bottom:0.5rem">Total Water Discharged</div>
                  <div style="color:var(--navy);font-size:1.5rem;font-weight:700">${formatNumber(totalWaterDischarged)} gallons</div>
                </div>
              `;
            }
            reportHTML += `</div>`;
          }
          
          // Display discharge location and source of output - check data, wellBasics, and flowReadings metadata
          const dischargeLocation = data.dischargeLocation || wellBasics.dischargeLocation || systemEquipment.dischargeLocation;
          const sourceOfOutput = data.sourceOfOutput || wellBasics.sourceOfOutput || systemEquipment.sourceOfOutput;
          console.log('üåä Flow test additional info:', {
            dischargeLocation,
            sourceOfOutput,
            hasDataDischarge: !!data.dischargeLocation,
            hasWellBasicsDischarge: !!wellBasics.dischargeLocation,
            hasSystemEquipmentDischarge: !!systemEquipment.dischargeLocation,
            wellBasicsKeys: Object.keys(wellBasics),
            systemEquipmentKeys: Object.keys(systemEquipment),
            dataKeys: Object.keys(data).filter(k => k.includes('discharge') || k.includes('source') || k.includes('output'))
          });
          if (dischargeLocation || sourceOfOutput) {
            reportHTML += `
              <div style="margin-top:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">
            `;
            if (dischargeLocation) {
              reportHTML += `
                <div class="report-item">
                  <div class="report-label">Location of Discharge</div>
                  <div class="report-value">${dischargeLocation}</div>
                </div>
              `;
            }
            if (sourceOfOutput) {
              reportHTML += `
                <div class="report-item">
                  <div class="report-label">Source of Output</div>
                  <div class="report-value">${sourceOfOutput}</div>
                </div>
              `;
            }
            reportHTML += `</div>`;
          }
          // Check for pumped down and recovery - check multiple possible field names
          const pumpedDownTo = data.pumpedDownTo || data.pumpedDown || wellBasics.pumpedDownTo || wellBasics.pumpedDown;
          const recoveryTime = data.recoveryTime || data.recovery || wellBasics.recoveryTime || wellBasics.recovery;
          if (pumpedDownTo && recoveryTime) {
            reportHTML += `
              <div class="flow-recovery-note" style="margin-top:1.5rem;padding:1rem;background:#f9f9f9;border-radius:8px">
                <strong>Recovery:</strong> Pumped down to ${pumpedDownTo} ft, recovered in ${recoveryTime} minutes
              </div>
            `;
          }
          reportHTML += `
            <div class="flow-percent-note" style="margin-top:1rem;padding:1rem;background:#f9f9f9;border-radius:8px;font-style:italic;color:#666">
              <strong>% Change:</strong> Well is deemed stable if final 3 readings are within 10% variation, with a minimum of 120 minutes total test length.
            </div>
          `;
          reportHTML += `</div>`;
        }

        // System Equipment - check both data and systemEquipment
        const pressureTankSize = data.pressureTankSize || systemEquipment.pressureTankSize;
        const prechargePSI = data.prechargePSI || systemEquipment.prechargePSI;
        const storageTanks = data.storageTanks || systemEquipment.storageTanks;
        const pumpMakeModel = data.pumpMakeModel || systemEquipment.pumpMakeModel;
        const pumpCondition = data.pumpCondition || systemEquipment.pumpCondition;
        const pressureTankCondition = data.pressureTankCondition || systemEquipment.pressureTankCondition;
        const wiringCondition = data.wiringCondition || systemEquipment.wiringCondition;
        const wellCapCondition = data.wellCapCondition || systemEquipment.wellCapCondition;
        const wellPumpLocation = data.wellPumpLocation || systemEquipment.wellPumpLocation;
        const waterTreatment = data.waterTreatment || systemEquipment.waterTreatment;
        
        if (pressureTankSize || pumpMakeModel || pumpCondition || pressureTankCondition || wiringCondition || wellCapCondition || wellPumpLocation || waterTreatment) {
          reportHTML += `
            <div class="report-section system-equipment-section">
              <h2>System Equipment</h2>
              <div class="report-grid">
          `;
          if (pressureTankSize) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Pressure Tank Size</div>
                <div class="report-value">${pressureTankSize} gallons</div>
              </div>
            `;
          }
          if (prechargePSI) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Pre-charge PSI</div>
                <div class="report-value">${prechargePSI} PSI</div>
              </div>
            `;
          }
          if (storageTanks) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Storage Tanks</div>
                <div class="report-value">${storageTanks} gallons</div>
              </div>
            `;
          }
          if (pumpMakeModel) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Pump Make/Model/HP</div>
                <div class="report-value">${pumpMakeModel}</div>
              </div>
            `;
          }
          if (pumpCondition) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Pump Condition</div>
                <div class="report-value">${pumpCondition}</div>
              </div>
            `;
          }
          if (pressureTankCondition) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Pressure Tank Condition</div>
                <div class="report-value">${pressureTankCondition}</div>
              </div>
            `;
          }
          if (wiringCondition) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Wiring Condition</div>
                <div class="report-value">${wiringCondition}</div>
              </div>
            `;
          }
          if (wellCapCondition) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Well Cap Condition</div>
                <div class="report-value">${wellCapCondition}</div>
              </div>
            `;
          }
          // Well Pump Location
          const wellPumpLocation = data.wellPumpLocation || systemEquipment.wellPumpLocation;
          if (wellPumpLocation) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Well Pump Location</div>
                <div class="report-value">${wellPumpLocation}</div>
              </div>
            `;
          }
          // Water Treatment Equipment
          const waterTreatment = data.waterTreatment || systemEquipment.waterTreatment;
          if (waterTreatment) {
            const treatmentDisplay = Array.isArray(waterTreatment) 
              ? waterTreatment.join(', ')
              : typeof waterTreatment === 'string' 
                ? waterTreatment.split(',').map(t => t.trim()).filter(Boolean).join(', ')
                : waterTreatment;
            if (treatmentDisplay && treatmentDisplay !== 'None' && treatmentDisplay !== '') {
              reportHTML += `
                <div class="report-item">
                  <div class="report-label">Water Treatment Equipment</div>
                  <div class="report-value">${treatmentDisplay}</div>
                </div>
              `;
            }
          }
          reportHTML += `
              </div>
            </div>
          `;
        }

        // Water Quality - check both data and waterQuality
        const coliformEcoli = data.coliformEcoli || waterQuality.coliformEcoli || waterQuality.coliform;
        const nitrate = data.nitrate || waterQuality.nitrate;
        const arsenic = data.arsenic || waterQuality.arsenic;
        const lead = data.lead || waterQuality.lead;
        const iron = data.iron || waterQuality.iron;
        const manganese = data.manganese || waterQuality.manganese;
        const hardness = data.hardness || waterQuality.hardness;
        const ph = data.ph || waterQuality.ph;
        const tds = data.tds || waterQuality.tds;
        const ecoli = data.ecoli || waterQuality.ecoli;
        const overallRating = data.overallRating || waterQuality.overallRating;
        
        console.log('üíß Water Quality check:', {
          coliformEcoli,
          ecoli,
          nitrate,
          arsenic,
          lead,
          iron,
          manganese,
          hardness,
          ph,
          tds,
          overallRating,
          waterQualityKeys: Object.keys(waterQuality),
          waterQualityObject: waterQuality,
          dataKeys: Object.keys(data).filter(k => k.includes('coliform') || k.includes('nitrate') || k.includes('arsenic') || k.includes('lead') || k.includes('iron') || k.includes('manganese') || k.includes('hardness') || k.includes('ph') || k.includes('tds'))
        });
        
        if (coliformEcoli || ecoli || nitrate || arsenic || lead || iron || manganese || hardness || ph || tds || overallRating) {
          reportHTML += `
            <div class="report-section water-quality-section">
              <h2>Water Quality</h2>
              <div class="report-grid">
          `;
          if (coliformEcoli || ecoli) {
            const coliformDisplay = coliformEcoli || ecoli;
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Coliform / E.coli</div>
                <div class="report-value">${coliformDisplay}</div>
              </div>
            `;
          }
          if (nitrate) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Nitrate</div>
                <div class="report-value">${nitrate} mg/L</div>
              </div>
            `;
          }
          if (arsenic) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Arsenic</div>
                <div class="report-value">${arsenic} ppb</div>
              </div>
            `;
          }
          if (lead) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Lead</div>
                <div class="report-value">${lead} ppb</div>
              </div>
            `;
          }
          if (iron) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Iron</div>
                <div class="report-value">${iron} mg/L</div>
              </div>
            `;
          }
          if (manganese) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Manganese</div>
                <div class="report-value">${manganese} mg/L</div>
              </div>
            `;
          }
          if (hardness) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Hardness</div>
                <div class="report-value">${hardness} mg/L</div>
              </div>
            `;
          }
          if (ph) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">pH</div>
                <div class="report-value">${ph}</div>
              </div>
            `;
          }
          if (tds) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">TDS</div>
                <div class="report-value">${tds} mg/L</div>
              </div>
            `;
          }
          if (overallRating) {
            reportHTML += `
              <div class="report-item">
                <div class="report-label">Overall Rating</div>
                <div class="report-value">${overallRating}</div>
              </div>
            `;
          }
          reportHTML += `
              </div>
            </div>
          `;
        }

        // Recommendations
        if (data.recommendations) {
          reportHTML += `
            <div class="report-section recommendations-section">
              <h2>Recommendations</h2>
              <div class="recommendations-content">
                ${data.recommendations}
              </div>
            </div>
          `;
        }

        // Receipt Section - Calculate receipt using shared function
        // Use dataForReceipt which has water quality fields merged in
        console.log('üí∞ Calculating receipt with dataForReceipt:', {
          hasColiform: !!dataForReceipt.coliform,
          hasEcoli: !!dataForReceipt.ecoli,
          hasNitrate: !!dataForReceipt.nitrate,
          coliformValue: dataForReceipt.coliform,
          ecoliValue: dataForReceipt.ecoli,
          nitrateValue: dataForReceipt.nitrate,
          allKeys: Object.keys(dataForReceipt)
        });
        const receiptCalc = calculateReceipt(job, dataForReceipt);
        console.log('üí∞ Receipt calculation result:', receiptCalc);
        const lineItems = receiptCalc.lineItems;
        const total = receiptCalc.total;
        
        reportHTML += `
          <div class="report-section" style="page-break-before:always">
            <h2>Receipt</h2>
            <div style="margin-top:2rem">
        `;

        // Build receipt table
        if (lineItems.length > 0) {
          reportHTML += `
            <table style="width:100%;border-collapse:collapse;margin-bottom:2rem">
              <thead>
                <tr style="border-bottom:2px solid #ddd">
                  <th style="text-align:left;padding:1rem;font-weight:600;color:var(--navy)">Description</th>
                  <th style="text-align:right;padding:1rem;font-weight:600;color:var(--navy)">Amount</th>
                </tr>
              </thead>
              <tbody>
          `;

          lineItems.forEach(item => {
            reportHTML += `
              <tr style="border-bottom:1px solid #eee">
                <td style="padding:1rem">${item.description}</td>
                <td style="text-align:right;padding:1rem">$${item.amount.toFixed(2)}</td>
              </tr>
            `;
          });

          reportHTML += `
              </tbody>
              <tfoot>
                <tr style="border-top:2px solid #ddd">
                  <td style="padding:1rem;font-weight:700;font-size:1.1rem;color:var(--navy)">Total</td>
                  <td style="text-align:right;padding:1rem;font-weight:700;font-size:1.1rem;color:var(--navy)">$${total.toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>
          `;
        } else {
          reportHTML += `
            <p style="color:var(--gray);text-align:center;padding:2rem">No charges for this report.</p>
          `;
        }

        reportHTML += `
            </div>
          </div>
        `;

          console.log('üìù Setting reportContent HTML. Job info section preview:');
          const jobInfoIndex = reportHTML.indexOf('Job Information');
          if (jobInfoIndex !== -1) {
            const jobInfoPreview = reportHTML.substring(jobInfoIndex, jobInfoIndex + 500);
            console.log(jobInfoPreview);
          }
          
          // Set HTML
          document.getElementById('reportContent').innerHTML = reportHTML;
          
          // Immediately after setting HTML, directly update the job info values
          // This ensures they're correct even if there's any template string evaluation issue
          setTimeout(() => {
            const jobInfoSection = document.querySelector('.report-section h2');
            if (jobInfoSection && jobInfoSection.textContent === 'Job Information') {
              const reportItems = document.querySelectorAll('.report-grid .report-item');
              if (reportItems.length >= 3) {
                // Property Address (index 0)
                const addressValueEl = reportItems[0]?.querySelector('.report-value');
                if (addressValueEl) {
                  addressValueEl.textContent = jobAddress;
                  console.log('üîß Directly set address:', jobAddress);
                }
                // County (index 1)
                const countyValueEl = reportItems[1]?.querySelector('.report-value');
                if (countyValueEl) {
                  countyValueEl.textContent = jobCounty;
                  console.log('üîß Directly set county:', jobCounty);
                }
                // Client Name (index 2)
                const clientNameValueEl = reportItems[2]?.querySelector('.report-value');
                if (clientNameValueEl) {
                  clientNameValueEl.textContent = jobClientName;
                  console.log('üîß Directly set client name:', jobClientName);
                }
              }
            }
            
            // Verify after direct update
            const addressEl = document.querySelector('.report-grid .report-value');
            if (addressEl) {
              console.log('‚úÖ Final verification - First report-value:', addressEl.textContent);
              const allValues = Array.from(document.querySelectorAll('.report-grid .report-value')).map(el => el.textContent.trim());
              console.log('‚úÖ Final verification - All report-values:', allValues);
              if (allValues.includes('N/A')) {
                console.error('‚ùå ERROR: Still seeing "N/A" after direct update!');
              } else {
                console.log('‚úÖ All values are correct after direct update');
              }
            }
          }, 50);
          
          // Store receipt data for modal
          window.receiptData = { job, data, lineItems, total };
          
          // Initialize map if coordinates exist
          const mapId = report.id || 'map';
          if (window.mapCoordinates && window.mapCoordinates[mapId]) {
            setTimeout(() => {
              initializeWellHeadMap(mapId, window.mapCoordinates[mapId].lat, window.mapCoordinates[mapId].lng);
            }, 500);
          }
        } catch (error) {
          console.error('Error loading report:', error);
          document.getElementById('reportContent').innerHTML = `
            <div class="report-section">
              <p style="color:var(--gray);text-align:center">Error loading report: ${error.message}</p>
            </div>
          `;
        }
      }

      // Function to show receipt modal
      function showReceiptModal() {
        if (!window.receiptData) {
          alert('Receipt data not available. Please wait for the report to load.');
          return;
        }

        const { lineItems, total } = window.receiptData;
        const modalBody = document.getElementById('receiptModalBody');

        let receiptHTML = '<h2>Receipt</h2>';

        if (lineItems.length > 0) {
          receiptHTML += `
            <table class="receipt-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th class="amount">Amount</th>
                </tr>
              </thead>
              <tbody>
          `;

          lineItems.forEach(item => {
            receiptHTML += `
              <tr>
                <td>${item.description}</td>
                <td class="amount">$${item.amount.toFixed(2)}</td>
              </tr>
            `;
          });

          receiptHTML += `
              </tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td class="amount">$${total.toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>
          `;
        } else {
          receiptHTML += `
            <p style="color:var(--gray);text-align:center;padding:2rem">No charges for this report.</p>
          `;
        }

        modalBody.innerHTML = receiptHTML;
        document.getElementById('receiptModal').classList.add('active');
      }

      // Function to close receipt modal
      function closeReceiptModal(event) {
        if (!event || event.target.id === 'receiptModal' || event.target.classList.contains('receipt-modal-close')) {
          document.getElementById('receiptModal').classList.remove('active');
        }
      }

      // Function to initialize well head map
      function initializeWellHeadMap(reportId, lat, lng) {
        const mapContainer = document.getElementById(`wellHeadMap_${reportId}`);
        if (!mapContainer) {
          console.warn('Map container not found');
          return;
        }

        // Check if Leaflet is loaded
        if (typeof L === 'undefined') {
          console.warn('Leaflet not loaded, map cannot be displayed');
          mapContainer.innerHTML = '<p style="padding:2rem;text-align:center;color:#666">Map library not available</p>';
          return;
        }

        try {
          // Initialize map centered on coordinates
          // Zoom level 20 for detailed close-up view (satellite view)
          const map = L.map(mapContainer, {
            center: [lat, lng],
            zoom: 20,
            zoomControl: true
          });

          // Add satellite imagery (Esri World Imagery)
          L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri',
            maxZoom: 19
          }).addTo(map);

          // Add marker at well head location
          const marker = L.marker([lat, lng], {
            icon: L.divIcon({
              className: 'well-head-marker',
              html: '<div style="width:30px;height:30px;background-color:#dc3545;border:4px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>',
              iconSize: [30, 30],
              iconAnchor: [15, 15]
            })
          }).addTo(map);

          // Add popup with coordinates
          marker.bindPopup(`Well Head Location<br>${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();

          // Store map reference
          if (!window.wellHeadMaps) window.wellHeadMaps = {};
          window.wellHeadMaps[reportId] = map;
        } catch (error) {
          console.error('Error initializing map:', error);
          mapContainer.innerHTML = `<p style="padding:2rem;text-align:center;color:#c33">Error loading map: ${error.message}</p>`;
        }
      }

      // Make functions globally accessible
      window.showReceiptModal = showReceiptModal;
      window.closeReceiptModal = closeReceiptModal;
      window.initializeWellHeadMap = initializeWellHeadMap;
      
      loadReport();
    }
  </script>
</body>
</html>
