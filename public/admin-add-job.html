<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Job | Peak to Plains Well Testing</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-header {
      background: var(--navy);
      color: white;
      padding: 1.5rem 0;
      margin-bottom: 2rem;
    }
    .admin-header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .admin-header h1 {
      color: white;
      margin: 0;
      font-size: 1.8rem;
    }
    .admin-header .back-btn {
      background: var(--brown);
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }
    .form-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1.5rem 4rem;
    }
    .form-box {
      background: white;
      padding: 3rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .form-box h2 {
      color: var(--navy);
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--green);
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      color: var(--navy);
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 1rem 1.5rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1.1rem;
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--green);
    }
    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    .services-section {
      margin-bottom: 1.5rem;
    }
    .service-option {
      margin-bottom: 1rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .service-option:hover {
      border-color: var(--green);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .service-label {
      display: flex;
      align-items: center;
      padding: 1.5rem;
      cursor: pointer;
    }
    .service-label input[type="radio"] {
      width: 24px;
      height: 24px;
      margin-right: 1.5rem;
      cursor: pointer;
      flex-shrink: 0;
    }
    .service-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex: 1;
    }
    .service-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--navy);
    }
    .service-price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--green);
    }
    .water-quality-tests {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .water-test-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .water-test-label:hover {
      border-color: var(--green);
      background: #f9f9f9;
    }
    .water-test-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 1rem;
      cursor: pointer;
    }
    .test-name {
      font-size: 1.1rem;
      color: var(--navy);
      font-weight: 500;
      flex: 1;
    }
    .test-price {
      font-size: 1.1rem;
      color: var(--gray);
      font-weight: 600;
    }
    .total-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #f4f0ea;
      border-radius: 8px;
      border: 2px solid var(--green);
    }
    .total-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .total-label {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--navy);
    }
    .total-amount {
      font-size: 2rem;
      font-weight: 700;
      color: var(--green);
    }
    .btn-cancel {
      background: #ccc;
      color: #333;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    .toast {
      position: fixed;
      top: 100px;
      right: 2rem;
      background: var(--green);
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: none;
      z-index: 10000;
    }
    .toast.show {
      display: block;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- INSERT HEADER -->
  <div w3-include-html="header.html"></div>
  
  <!-- Check authentication -->
  <script>
    if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
      window.location.href = 'admin-login.html';
    }
  </script>

  <div class="admin-header">
    <div class="container">
      <h1>Add New Job</h1>
      <a href="admin-dashboard.html" class="back-btn">← Back to Dashboard</a>
    </div>
  </div>

  <div class="form-container">
    <div class="form-box">
      <h2>Job Information</h2>
      <form id="addJobForm">
        <div class="form-group">
          <label for="propertyAddress">
            Property Address <span style="color:red">*</span>
          </label>
          <input type="text" 
                 id="propertyAddress" 
                 name="propertyAddress"
                 required
                 placeholder="Enter street address">
        </div>

        <div style="display:grid;grid-template-columns:1fr 2fr;gap:1rem">
          <div class="form-group">
            <label for="zip">
              ZIP Code
            </label>
            <input type="text" 
                   id="zip" 
                   name="zip"
                   placeholder="Enter ZIP"
                   maxlength="5"
                   onblur="lookupCityFromZip()">
          </div>

          <div class="form-group">
            <label for="city">
              City
            </label>
            <input type="text" 
                   id="city" 
                   name="city"
                   placeholder="Enter city (auto-filled from ZIP)">
          </div>
        </div>

        <div class="form-group">
          <label for="county">
            County <span style="color:red">*</span>
          </label>
          <select id="county" name="county" required>
            <option value="">Select a county</option>
            <option value="Adams">Adams</option>
            <option value="Alamosa">Alamosa</option>
            <option value="Arapahoe">Arapahoe</option>
            <option value="Archuleta">Archuleta</option>
            <option value="Baca">Baca</option>
            <option value="Bent">Bent</option>
            <option value="Boulder">Boulder</option>
            <option value="Broomfield">Broomfield</option>
            <option value="Chaffee">Chaffee</option>
            <option value="Cheyenne">Cheyenne</option>
            <option value="Clear Creek">Clear Creek</option>
            <option value="Conejos">Conejos</option>
            <option value="Costilla">Costilla</option>
            <option value="Crowley">Crowley</option>
            <option value="Custer">Custer</option>
            <option value="Delta">Delta</option>
            <option value="Denver">Denver</option>
            <option value="Dolores">Dolores</option>
            <option value="Douglas">Douglas</option>
            <option value="Eagle">Eagle</option>
            <option value="El Paso">El Paso</option>
            <option value="Elbert">Elbert</option>
            <option value="Fremont">Fremont</option>
            <option value="Garfield">Garfield</option>
            <option value="Gilpin">Gilpin</option>
            <option value="Grand">Grand</option>
            <option value="Gunnison">Gunnison</option>
            <option value="Hinsdale">Hinsdale</option>
            <option value="Huerfano">Huerfano</option>
            <option value="Jackson">Jackson</option>
            <option value="Jefferson">Jefferson</option>
            <option value="Kiowa">Kiowa</option>
            <option value="Kit Carson">Kit Carson</option>
            <option value="La Plata">La Plata</option>
            <option value="Lake">Lake</option>
            <option value="Larimer">Larimer</option>
            <option value="Las Animas">Las Animas</option>
            <option value="Lincoln">Lincoln</option>
            <option value="Logan">Logan</option>
            <option value="Mesa">Mesa</option>
            <option value="Mineral">Mineral</option>
            <option value="Moffat">Moffat</option>
            <option value="Montezuma">Montezuma</option>
            <option value="Montrose">Montrose</option>
            <option value="Morgan">Morgan</option>
            <option value="Otero">Otero</option>
            <option value="Ouray">Ouray</option>
            <option value="Park">Park</option>
            <option value="Phillips">Phillips</option>
            <option value="Pitkin">Pitkin</option>
            <option value="Prowers">Prowers</option>
            <option value="Pueblo">Pueblo</option>
            <option value="Rio Blanco">Rio Blanco</option>
            <option value="Rio Grande">Rio Grande</option>
            <option value="Routt">Routt</option>
            <option value="Saguache">Saguache</option>
            <option value="San Juan">San Juan</option>
            <option value="San Miguel">San Miguel</option>
            <option value="Sedgwick">Sedgwick</option>
            <option value="Summit">Summit</option>
            <option value="Teller">Teller</option>
            <option value="Washington">Washington</option>
            <option value="Weld">Weld</option>
            <option value="Yuma">Yuma</option>
          </select>
        </div>

        <div class="form-group">
          <label for="name">
            Client Name <span style="color:red">*</span>
          </label>
          <input type="text" 
                 id="name" 
                 name="name"
                 required
                 placeholder="Enter client's full name">
        </div>

        <div class="form-group">
          <label for="userRole">
            Client Role <span style="color:red">*</span>
          </label>
          <select id="userRole" name="userRole" required onchange="toggleOtherRoleInput()">
            <option value="">Select one</option>
            <option value="buyer">Buyer</option>
            <option value="owner">Owner</option>
            <option value="inspector">Inspector</option>
            <option value="buyers-agent">Buyer's Agent</option>
            <option value="sellers-agent">Seller's Agent</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group" id="otherRoleInput" style="display:none">
          <label for="otherRoleText">
            Please specify: <span style="color:red">*</span>
          </label>
          <input type="text" 
                 id="otherRoleText" 
                 name="otherRoleText"
                 placeholder="Enter role">
        </div>

        <div class="form-group">
          <label for="hasCistern">
            Is there a cistern or underground storage? <span style="color:red">*</span>
          </label>
          <div style="display:flex;gap:2rem;margin-top:0.5rem">
            <label style="display:flex;align-items:center;cursor:pointer;font-size:1.1rem">
              <input type="radio" 
                     name="hasCistern" 
                     value="yes" 
                     required
                     id="cisternYes"
                     onchange="handleCisternSelection('yes')"
                     style="width:20px;height:20px;margin-right:0.5rem;cursor:pointer">
              Yes
            </label>
            <label style="display:flex;align-items:center;cursor:pointer;font-size:1.1rem">
              <input type="radio" 
                     name="hasCistern" 
                     value="no" 
                     required
                     id="cisternNo"
                     onchange="handleCisternSelection('no')"
                     style="width:20px;height:20px;margin-right:0.5rem;cursor:pointer">
              No
            </label>
          </div>
        </div>

        <!-- Alternative Services (shown when cistern is Yes) -->
        <div id="alternativeServices" style="display:none;margin-top:1.5rem;padding:1.5rem;background:#f4f0ea;border-radius:8px;border:2px solid var(--green)">
          <h3 style="color:var(--navy);font-size:1.2rem;margin-bottom:1rem">Alternative Services Available</h3>
          
          <!-- Well Equipment Inspection -->
          <div style="margin-bottom:1.5rem">
            <label style="display:flex;align-items:flex-start;cursor:pointer;font-size:1.1rem">
              <input type="checkbox" 
                     name="equipmentInspection" 
                     value="yes"
                     id="equipmentInspection"
                     style="width:20px;height:20px;margin-right:0.75rem;margin-top:0.2rem;cursor:pointer;flex-shrink:0">
              <div style="flex:1">
                <span style="color:var(--navy);font-weight:600">Well Equipment Inspection</span>
                <p style="font-size:0.95rem;color:var(--gray);margin:0.5rem 0 0 0;line-height:1.5">
                  $150 base fee, plus potential trip distance charges
                </p>
              </div>
            </label>
          </div>

          <!-- Water Quality Testing -->
          <div>
            <label style="display:flex;align-items:flex-start;cursor:pointer;font-size:1.1rem;margin-bottom:0.75rem">
              <input type="checkbox" 
                     name="waterQualityTesting" 
                     value="yes"
                     id="waterQualityTesting"
                     onchange="toggleWaterQualityOptions()"
                     style="width:20px;height:20px;margin-right:0.75rem;margin-top:0.2rem;cursor:pointer;flex-shrink:0">
              <div style="flex:1">
                <span style="color:var(--navy);font-weight:600">Water Quality Testing</span>
                <p style="font-size:0.95rem;color:var(--gray);margin:0.5rem 0 0 0;line-height:1.5">
                  A la carte pricing, depending on chosen tests
                </p>
              </div>
            </label>
            
            <!-- Water Quality Test Options -->
            <div id="waterQualityOptions" style="display:none;margin-left:2rem;margin-top:1rem;padding:1rem;background:white;border-radius:6px;border:1px solid #ddd">
              <p style="font-size:0.9rem;color:var(--gray);margin-bottom:0.75rem;font-weight:600">Select tests (pricing varies):</p>
              <div style="display:grid;gap:0.75rem">
                <label style="display:flex;align-items:center;cursor:pointer;font-size:0.95rem">
                  <input type="checkbox" name="waterTest" value="bacteria" style="width:18px;height:18px;margin-right:0.5rem;cursor:pointer">
                  <span>Bacteria Testing</span>
                </label>
                <label style="display:flex;align-items:center;cursor:pointer;font-size:0.95rem">
                  <input type="checkbox" name="waterTest" value="nitrate" style="width:18px;height:18px;margin-right:0.5rem;cursor:pointer">
                  <span>Nitrate Testing</span>
                </label>
                <label style="display:flex;align-items:center;cursor:pointer;font-size:0.95rem">
                  <input type="checkbox" name="waterTest" value="full-panel" style="width:18px;height:18px;margin-right:0.5rem;cursor:pointer">
                  <span>Full Water Quality Panel</span>
                </label>
                <label style="display:flex;align-items:center;cursor:pointer;font-size:0.95rem">
                  <input type="checkbox" name="waterTest" value="radon" style="width:18px;height:18px;margin-right:0.5rem;cursor:pointer">
                  <span>Radon in Water</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="wellPermitNumber">
            Well Permit # (Optional)
          </label>
          <p style="font-size:0.95rem;color:var(--gray);margin-bottom:0.8rem">
            Don't know your permit number? 
            <a href="https://dwr.state.co.us/Tools/WellPermits" target="_blank" style="color:var(--green);font-weight:600;text-decoration:none">
              Search for it here →
            </a>
          </p>
          <div style="display:flex;gap:1rem;flex-wrap:wrap">
            <input type="text" 
                   id="wellPermitNumber" 
                   name="wellPermitNumber"
                   placeholder="Enter well permit number"
                   style="flex:1;min-width:200px">
            <a href="https://dwr.state.co.us/Tools/WellPermits" 
               target="_blank" 
               style="background:var(--green);color:white;padding:1rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:600;white-space:nowrap;display:inline-flex;align-items:center">
              Search Permit Database
            </a>
          </div>
        </div>

        <div class="form-group">
          <label for="willBePresent">
            Will someone be there to allow access? <span style="color:red">*</span>
          </label>
          <div style="display:flex;gap:2rem;margin-top:0.5rem">
            <label style="display:flex;align-items:center;cursor:pointer;font-size:1.1rem">
              <input type="radio" 
                     name="willBePresent" 
                     value="yes" 
                     required
                     id="willBePresentYes"
                     onchange="handleAccessSelection('yes')"
                     style="width:20px;height:20px;margin-right:0.5rem;cursor:pointer">
              Yes
            </label>
            <label style="display:flex;align-items:center;cursor:pointer;font-size:1.1rem">
              <input type="radio" 
                     name="willBePresent" 
                     value="no" 
                     required
                     id="willBePresentNo"
                     onchange="handleAccessSelection('no')"
                     style="width:20px;height:20px;margin-right:0.5rem;cursor:pointer">
              No
            </label>
          </div>
        </div>

        <div class="form-group" id="accessInstructionsGroup" style="display:none">
          <label for="accessInstructions">
            Access Instructions <span style="color:red">*</span>
          </label>
          <textarea id="accessInstructions" 
                    name="accessInstructions"
                    placeholder="Enter access instructions (e.g., lockbox code, gate code, key location, etc.)"
                    rows="3"
                    style="width:100%;padding:1rem 1.5rem;border:2px solid #ddd;border-radius:8px;font-size:1.1rem;font-family:'Inter',sans-serif;box-sizing:border-box;resize:vertical"></textarea>
        </div>

        <div class="form-group">
          <label for="assignedTech">
            Assign Tech (Optional)
          </label>
          <select id="assignedTech" name="assignedTech">
            <option value="">Select a tech</option>
            <!-- Techs will be loaded here -->
          </select>
        </div>

        <div class="form-group">
          <label for="scheduledDate">
            Scheduled Date (Optional)
          </label>
          <input type="datetime-local" 
                 id="scheduledDate" 
                 name="scheduledDate">
        </div>

        <div class="form-group">
          <label for="notes">
            Notes (Optional)
          </label>
          <textarea id="notes" 
                    name="notes" 
                    rows="4"
                    placeholder="Any additional notes about this job..."
                    style="width:100%;padding:1rem;border:2px solid #ddd;border-radius:8px;font-family:'Inter',sans-serif;font-size:1rem;box-sizing:border-box;resize:vertical"></textarea>
        </div>

        <div class="form-actions">
          <a href="admin-dashboard.html" class="btn-cancel">Cancel</a>
          <button type="button" onclick="goToServicesPage()" class="btn" style="flex:1">Next</button>
        </div>
      </form>
    </div>

    <!-- Services Page -->
    <div class="form-box" id="servicesPage" style="display:none">
      <h2>Services Requested</h2>
      <div id="servicesForm">
        <div class="services-section">
          <div class="service-option">
            <label class="service-label">
              <input type="radio" name="mainService" value="flow-test-bacteria" id="flowTestBacteria" onchange="calculateTotal()">
              <div class="service-details">
                <span class="service-name">Flow Test & Bacteria</span>
                <span class="service-price">$449</span>
              </div>
            </label>
          </div>

          <div class="service-option">
            <label class="service-label">
              <input type="radio" name="mainService" value="inspection-only" id="inspectionOnly" onchange="calculateTotal()">
              <div class="service-details">
                <span class="service-name">Inspection Only (no flow test)</span>
                <span class="service-price">$150</span>
              </div>
            </label>
          </div>
        </div>

        <div class="services-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #eee">
          <h3 style="color: var(--navy); margin-bottom: 1rem; font-size: 1.3rem">Water Quality Tests</h3>
          <p style="color: var(--gray); margin-bottom: 1.5rem; font-size: 0.95rem">Select additional water quality tests (all tests $50 each):</p>
          
          <div class="water-quality-tests">
            <label class="water-test-label">
              <input type="checkbox" name="waterTest" value="bacteria" id="waterTestBacteria" onchange="calculateTotal()">
              <span class="test-name">Bacteria Testing</span>
              <span class="test-price">$50</span>
            </label>
            
            <label class="water-test-label">
              <input type="checkbox" name="waterTest" value="nitrate" id="waterTestNitrate" onchange="calculateTotal()">
              <span class="test-name">Nitrate Testing</span>
              <span class="test-price">$50</span>
            </label>
            
            <label class="water-test-label">
              <input type="checkbox" name="waterTest" value="full-panel" id="waterTestFullPanel" onchange="calculateTotal()">
              <span class="test-name">Full Water Quality Panel</span>
              <span class="test-price">$50</span>
            </label>
            
            <label class="water-test-label">
              <input type="checkbox" name="waterTest" value="radon" id="waterTestRadon" onchange="calculateTotal()">
              <span class="test-name">Radon in Water</span>
              <span class="test-price">$50</span>
            </label>
          </div>
        </div>

        <div class="total-section">
          <div class="total-line">
            <span class="total-label">Total:</span>
            <span class="total-amount" id="totalAmount">$0</span>
          </div>
        </div>

        <div class="form-actions" style="margin-top: 2rem">
          <button type="button" onclick="goBackToJobInfo()" class="btn-cancel">← Back</button>
          <button type="button" onclick="createJob()" class="btn" style="flex:1">Create Job</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Job created successfully!</div>

  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script src="api.js"></script>
  <script>w3.includeHTML();</script>
  <script>
    function toggleOtherRoleInput() {
      const roleSelect = document.getElementById('userRole');
      const otherInput = document.getElementById('otherRoleInput');
      const otherTextInput = document.getElementById('otherRoleText');
      
      if (roleSelect.value === 'other') {
        otherInput.style.display = 'block';
        otherTextInput.required = true;
      } else {
        otherInput.style.display = 'none';
        otherTextInput.required = false;
        otherTextInput.value = '';
      }
    }

    // Lookup city and county from ZIP code
    async function lookupCityFromZip() {
      const zipInput = document.getElementById('zip');
      const cityInput = document.getElementById('city');
      const countySelect = document.getElementById('county');
      
      if (!zipInput || !cityInput) return;
      
      const zip = zipInput.value.trim();
      
      // Only lookup if ZIP is 5 digits
      if (zip.length === 5 && /^\d{5}$/.test(zip)) {
        try {
          // Use zippopotam.us API (free, no API key required)
          const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
          
          if (response.ok) {
            const data = await response.json();
            if (data.places && data.places.length > 0) {
              // Use the first place (most common city for that ZIP)
              const city = data.places[0]['place name'];
              cityInput.value = city;
              
              // Try to get county from the place data or use geocoding
              // Note: zippopotam.us doesn't provide county, so we'll use a geocoding service
              if (countySelect) {
                await lookupCountyFromAddress(city, zip);
              }
            }
          } else {
            // If API fails, just leave city empty
            console.log('Could not lookup city for ZIP:', zip);
          }
        } catch (error) {
          console.log('Error looking up city:', error);
          // Silently fail - user can still enter city manually
        }
      }
    }

    // Lookup county from address using geocoding
    async function lookupCountyFromAddress(city, zip) {
      const addressInput = document.getElementById('propertyAddress');
      const countySelect = document.getElementById('county');
      
      if (!addressInput || !countySelect) return;
      
      const address = addressInput.value.trim();
      if (!address && !city) return;
      
      try {
        // Build full address for geocoding
        let fullAddress = address;
        if (city) fullAddress += ', ' + city;
        if (zip) fullAddress += ' ' + zip;
        fullAddress += ', Colorado';
        
        // Use Nominatim (OpenStreetMap) geocoding service (free, no API key)
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1&addressdetails=1`, {
          headers: {
            'User-Agent': 'WellTestingApp/1.0'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.length > 0 && data[0].address) {
            // Try to get county from address object
            const addressObj = data[0].address;
            let countyName = addressObj.county || addressObj.municipality || null;
            
            // If county includes "County", remove it
            if (countyName && countyName.includes('County')) {
              countyName = countyName.replace(' County', '').trim();
            }
            
            // Try to match county name with dropdown options
            if (countyName) {
              const options = countySelect.options;
              for (let i = 0; i < options.length; i++) {
                if (options[i].value && options[i].value.toLowerCase() === countyName.toLowerCase()) {
                  countySelect.value = options[i].value;
                  return;
                }
              }
            }
            
            // Fallback: try to find county in display_name
            const addressParts = data[0].display_name.split(',');
            for (let part of addressParts) {
              part = part.trim();
              const options = countySelect.options;
              for (let i = 0; i < options.length; i++) {
                if (options[i].value && part.toLowerCase().includes(options[i].value.toLowerCase())) {
                  countySelect.value = options[i].value;
                  return;
                }
              }
            }
          }
        }
      } catch (error) {
        console.log('Error looking up county:', error);
        // Silently fail - user can still select county manually
      }
    }

    // Handle cistern selection
    function handleCisternSelection(value) {
      if (value === 'yes') {
        // Show alternative services directly
        document.getElementById('alternativeServices').style.display = 'block';
      } else {
        // Hide alternative services
        document.getElementById('alternativeServices').style.display = 'none';
        // Uncheck all alternative service options
        document.getElementById('equipmentInspection').checked = false;
        document.getElementById('waterQualityTesting').checked = false;
        toggleWaterQualityOptions();
      }
    }

    // Toggle water quality test options
    function toggleWaterQualityOptions() {
      const waterQualityCheckbox = document.getElementById('waterQualityTesting');
      const optionsDiv = document.getElementById('waterQualityOptions');
      
      if (waterQualityCheckbox && optionsDiv) {
        if (waterQualityCheckbox.checked) {
          optionsDiv.style.display = 'block';
        } else {
          optionsDiv.style.display = 'none';
          // Uncheck all water test options
          const testCheckboxes = optionsDiv.querySelectorAll('input[type="checkbox"][name="waterTest"]');
          testCheckboxes.forEach(cb => cb.checked = false);
        }
      }
    }

    // Handle access selection
    function handleAccessSelection(value) {
      const accessInstructionsGroup = document.getElementById('accessInstructionsGroup');
      const accessInstructionsInput = document.getElementById('accessInstructions');
      
      if (value === 'no') {
        accessInstructionsGroup.style.display = 'block';
        accessInstructionsInput.required = true;
      } else {
        accessInstructionsGroup.style.display = 'none';
        accessInstructionsInput.required = false;
        accessInstructionsInput.value = '';
      }
    }


    // Load techs for assignment
    async function loadTechs() {
      try {
        const techs = await window.techsAPI.getAll();
        const assignedTechSelect = document.getElementById('assignedTech');
        if (assignedTechSelect) {
          // Clear existing options except the first "Select a tech" option
          assignedTechSelect.innerHTML = '<option value="">Select a tech</option>';
          
          techs.forEach(tech => {
            if (tech.active !== false) {
              const option = document.createElement('option');
              option.value = tech.id;
              option.textContent = tech.name;
              assignedTechSelect.appendChild(option);
            }
          });
        }
      } catch (error) {
        console.error('Error loading techs:', error);
      }
    }

    // Load techs on page load
    loadTechs();

    // Check for date parameter in URL and pre-fill scheduled date
    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get('date');
    if (dateParam) {
      // Format date for datetime-local input (YYYY-MM-DDTHH:mm)
      // Default to 9:00 AM
      const scheduledDateInput = document.getElementById('scheduledDate');
      if (scheduledDateInput) {
        scheduledDateInput.value = dateParam + 'T09:00';
      }
    }

    // Navigation functions
    function goToServicesPage() {
      const form = document.getElementById('addJobForm');
      
      // Check if required fields are filled
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Validate "other" role if selected
      const userRole = document.getElementById('userRole').value;
      if (userRole === 'other') {
        const otherRoleText = document.getElementById('otherRoleText').value.trim();
        if (!otherRoleText) {
          alert('Please specify the role.');
          return;
        }
      }

      // Validate access instructions if needed
      const willBePresent = document.querySelector('input[name="willBePresent"]:checked');
      if (willBePresent && willBePresent.value === 'no') {
        const accessInstructions = document.getElementById('accessInstructions').value.trim();
        if (!accessInstructions) {
          alert('Please provide access instructions.');
          document.getElementById('accessInstructionsGroup').style.display = 'block';
          return;
        }
      }

      // Hide first page and show services page
      document.querySelector('.form-box:first-of-type').style.display = 'none';
      document.getElementById('servicesPage').style.display = 'block';
      
      // Calculate initial total
      calculateTotal();
    }

    function goBackToJobInfo() {
      document.getElementById('servicesPage').style.display = 'none';
      document.querySelector('.form-box:first-of-type').style.display = 'block';
    }

    function calculateTotal() {
      let total = 0;

      // Check main service selection
      const flowTestBacteria = document.getElementById('flowTestBacteria');
      const inspectionOnly = document.getElementById('inspectionOnly');

      if (flowTestBacteria && flowTestBacteria.checked) {
        total += 449;
      } else if (inspectionOnly && inspectionOnly.checked) {
        total += 150;
      }

      // Check water quality tests (all $50 each)
      const waterTests = document.querySelectorAll('input[name="waterTest"]:checked');
      total += waterTests.length * 50;

      // Update total display
      const totalAmount = document.getElementById('totalAmount');
      if (totalAmount) {
        totalAmount.textContent = '$' + total.toLocaleString();
      }
    }

    async function createJob() {
      // Validate required fields from first page
      const form = document.getElementById('addJobForm');
      if (!form.checkValidity()) {
        alert('Please fill in all required fields on the first page.');
        goBackToJobInfo();
        form.reportValidity();
        return;
      }

      // Validate "other" role if selected
      const userRole = document.getElementById('userRole').value;
      if (userRole === 'other') {
        const otherRoleText = document.getElementById('otherRoleText').value.trim();
        if (!otherRoleText) {
          alert('Please specify the role.');
          goBackToJobInfo();
          return;
        }
      }

      // Validate access instructions if needed
      const willBePresent = document.querySelector('input[name="willBePresent"]:checked');
      if (willBePresent && willBePresent.value === 'no') {
        const accessInstructions = document.getElementById('accessInstructions').value.trim();
        if (!accessInstructions) {
          alert('Please provide access instructions.');
          goBackToJobInfo();
          document.getElementById('accessInstructionsGroup').style.display = 'block';
          return;
        }
      }

      // Validate at least one service is selected
      const mainService = document.querySelector('input[name="mainService"]:checked');
      const waterTests = document.querySelectorAll('input[name="waterTest"]:checked');
      
      if (!mainService && waterTests.length === 0) {
        alert('Please select at least one service.');
        return;
      }

      // Gather form data
      const accessInstructions = document.getElementById('accessInstructions');
      const equipmentInspection = document.getElementById('equipmentInspection');
      
      // Get selected services
      const selectedServices = [];
      if (mainService) {
        selectedServices.push(mainService.value);
      }
      waterTests.forEach(test => {
        selectedServices.push(test.value);
      });

      const assignedTechSelect = document.getElementById('assignedTech');
      const assignedTechId = assignedTechSelect ? assignedTechSelect.value : null;

      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const clientName = `${firstName} ${lastName}`.trim();

      const jobData = {
        propertyAddress: document.getElementById('propertyAddress').value,
        city: document.getElementById('city').value || null,
        zip: document.getElementById('zip').value || null,
        county: document.getElementById('county').value,
        name: clientName,
        firstName: firstName,
        lastName: lastName,
        userRole: userRole === 'other' 
          ? document.getElementById('otherRoleText').value 
          : userRole,
        hasCistern: document.querySelector('input[name="hasCistern"]:checked')?.value || null,
        equipmentInspection: equipmentInspection && equipmentInspection.checked ? 'yes' : null,
        wellPermitNumber: document.getElementById('wellPermitNumber').value || null,
        willBePresent: willBePresent ? willBePresent.value : null,
        accessInstructions: (willBePresent && willBePresent.value === 'no' && accessInstructions) ? accessInstructions.value : null,
        assignedTechId: assignedTechId || null,
        scheduledDate: document.getElementById('scheduledDate').value || null,
        notes: document.getElementById('notes').value || null,
        services: selectedServices,
        totalPrice: calculateTotalAmount(),
        status: 'pending',
        createdBy: 'admin'
      };

      try {
        // Create job via API
        await window.jobsAPI.create(jobData);

        // Show success toast
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        
        // Redirect to dashboard after a short delay
        setTimeout(() => {
          window.location.href = 'admin-dashboard.html';
        }, 1500);
      } catch (error) {
        console.error('Error creating job:', error);
        alert('Failed to create job: ' + error.message);
      }
    }

    function calculateTotalAmount() {
      let total = 0;

      const flowTestBacteria = document.getElementById('flowTestBacteria');
      const inspectionOnly = document.getElementById('inspectionOnly');

      if (flowTestBacteria && flowTestBacteria.checked) {
        total += 449;
      } else if (inspectionOnly && inspectionOnly.checked) {
        total += 150;
      }

      const waterTests = document.querySelectorAll('input[name="waterTest"]:checked');
      total += waterTests.length * 50;

      return total;
    }
  </script>
</body>
</html>

